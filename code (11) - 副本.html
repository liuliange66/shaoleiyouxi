<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Removed maximum-scale and user-scalable for accessibility -->
    <title>æ‰«é›· - å¯çˆ±å¡é€šé£ v7 (åˆå¹¶è°ƒè¯•ä¸åŠŸèƒ½)</title>
    <style>
        /* --- Reset & Base Styles --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: 'Arial Rounded MT Bold', 'Helvetica Rounded', Arial, sans-serif;
            display: flex; justify-content: center; align-items: center;
            /* Simulated background */
            background: linear-gradient( to bottom, #c8e6c9 0%, #c8e6c9 25%, #a5d6a7 25%, #a5d6a7 50%, #c8e6c9 50%, #c8e6c9 75%, #a5d6a7 75%, #a5d6a7 100% );
            background-size: 100% 200px;
            color: #333;
            /* Added vendor prefixes for user-select */
            -webkit-user-select: none; /* Safari/WebKit */
            -moz-user-select: none;    /* Firefox */
            -ms-user-select: none;     /* IE/Edge */
            user-select: none;         /* Standard */
        }

        /* --- CSS Variables --- */
        :root {
            --cell-size: 35px; /* Dynamically updated by JS */
            /* Colors */
            --bg-light-green: #c8e6c9; --bg-medium-green: #a5d6a7; --board-bg: #d7ccc8;
            --cell-hidden-bg: #fff9e1; --cell-hidden-border: #efebe9; --cell-revealed-bg: #a1887f;
            --cell-revealed-border: #8d6e63; --header-text: white; --header-level-bg: #333;
            --header-mine-icon-bg: #424242; --header-mine-icon-spikes: #616161; --heart-color: #e57373;
            --settings-icon-bg: #ffecb3; --settings-icon-gear: white; --help-icon-bg: #a1c4fd;
            --help-icon-mark: white; --modal-bg: #fafafa; --modal-header-bg: #333;
            --modal-header-text: #ffeb3b; --modal-border: #e0e0e0; --modal-shadow: rgba(0, 0, 0, 0.25);
            --modal-overlay-bg: rgba(0, 0, 0, 0.5); --toggle-bg-off: #bdbdbd; --toggle-bg-on: #81c784;
            --toggle-knob: white; --button-border: #333; --button-text: #333;
            --button-primary-bg: #ff9800; --button-secondary-bg: white; --button-abandon-bg: #333;
            --button-abandon-text: #f44336; --link-color: #1976d2;
            /* Number Colors */
            --num-1: #4caf50; --num-2: #ff9800; --num-3: #f44336; --num-4: #2196f3;
            --num-5: #ab47bc; --num-6: #00bcd4; --num-7: #795548; --num-8: #607d8b;
            /* Highlight Style */
            --highlight-outline-color: rgba(255, 215, 0, 0.9);
            /* Animation Durations */
            --flag-drop-duration: 0.5s; --flag-wobble-duration: 0.8s;
        }

        /* --- Layout & Component Styles --- */
        /* Styles for game-wrapper, status-bar, icons, board, cells, footer, modals, buttons, animations, status */
        /* Using the complete and corrected CSS block from v6 (no functional CSS changes needed here) */
        /* ... (Paste the complete CSS block from the corrected v6 here) ... */
         /* --- Main Game Wrapper --- */
         .game-wrapper { width: 100%; max-width: 450px; height: 100%; display: flex; flex-direction: column; padding: 15px; }
         /* --- Header / Status Bar --- */
         .status-bar { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; padding: 5px; margin-bottom: 10px; gap: 10px; z-index: 1; }
         .status-left, .status-center, .status-right { display: flex; align-items: center; flex-basis: auto; }
         .status-left { gap: 8px; order: 1; } .status-center { flex-grow: 1; justify-content: center; order: 2; } .status-right { gap: 12px; margin-right: 0; order: 3; }
         #timer-display { font-size: 1.1em; font-weight: bold; color: var(--header-level-bg); background-color: white; padding: 3px 8px; border-radius: 10px; box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); min-width: 50px; text-align: center; order: 0; margin-right: 8px; }
         .icon-btn { width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); border: none; background-color: transparent; padding: 0; }
         .settings-icon { background-color: var(--settings-icon-bg); position: relative; } .settings-icon::before, .settings-icon::after { /* Gear simulation */ content:''; display:block; position:absolute; border-radius:50%; } .settings-icon::before {width:18px;height:18px;background-color:var(--settings-icon-gear);} .settings-icon::after {width:24px;height:24px;border:3px solid var(--settings-icon-gear);border-radius:3px;clip-path:polygon(50% 0%,61% 35%,98% 35%,68% 57%,79% 91%,50% 70%,21% 91%,32% 57%,2% 35%,39% 35%);}
         .help-icon { background-color: var(--help-icon-bg); position: relative; font-size: 20px; font-weight: bold; color: var(--help-icon-mark); } .help-icon::before { content: '?'; }
         .level-display { background-color: var(--header-level-bg); color: var(--header-text); padding: 5px 15px; border-radius: 15px; font-size: 1em; font-weight: bold; margin: 0 5px; }
         .hearts-display { display: flex; gap: 3px; } .heart-icon { font-size: 26px; color: var(--heart-color); line-height: 1; }
         .mines-display { display: flex; align-items: center; gap: 5px; color: var(--header-text); font-weight: bold; font-size: 1.2em; background-color: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 10px; }
         .mine-icon-display { width: 24px; height: 24px; background-color: var(--header-mine-icon-bg); border-radius: 50%; position: relative; border: 1px solid var(--header-mine-icon-spikes); } .mine-icon-display::before, .mine-icon-display::after { content: ''; position: absolute; background-color: var(--header-mine-icon-spikes); border-radius: 2px; } .mine-icon-display::before { width: 5px; height: 10px; top: -4px; left: calc(50% - 2.5px); } .mine-icon-display::after { width: 10px; height: 5px; top: calc(50% - 2.5px); left: -4px; }
         /* --- Board Area --- */
         .board-container { background-color: var(--board-bg); padding: 8px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); margin-bottom: 10px; flex-grow: 1; display: flex; justify-content: center; align-items: center; overflow: hidden; position: relative; }
         .board { display: grid; grid-template-columns: repeat(var(--cols, 10), var(--cell-size, 30px)); grid-template-rows: repeat(var(--rows, 10), var(--cell-size, 30px)); gap: 4px; position: relative; min-width: 100px; min-height: 100px; }
         /* --- Cell Styles --- */
         .cell { width: var(--cell-size); height: var(--cell-size); border-radius: 6px; display: flex; justify-content: center; align-items: center; font-size: calc(var(--cell-size) * 0.65); font-weight: bold; cursor: pointer; position: relative; transition: transform 0.1s ease, filter 0.2s ease, background-color 0.1s ease, box-shadow 0.1s ease; overflow: hidden; opacity: 1; visibility: visible; }
         .cell.hidden-style { background-color: var(--cell-hidden-bg); border: 1px solid var(--cell-hidden-border); box-shadow: inset 0 -2px 3px rgba(0,0,0,0.08); } .cell.hidden-style:hover { filter: brightness(0.95); } .cell.hidden-style:active { transform: scale(0.96); box-shadow: none; }
         .cell.revealed-style { background-color: var(--cell-revealed-bg); border: 1px solid var(--cell-revealed-border); cursor: default; box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); animation: reveal-pop 0.3s ease-out; }
         .cell.highlighted-neighbor {
          box-shadow: 0 0 0 4px var(--highlight-outline-color) !important;
          z-index: 2;
        }
         .cell.flagged-style { background-color: var(--cell-hidden-bg); border: 1px solid var(--cell-hidden-border); box-shadow: inset 0 -2px 3px rgba(0,0,0,0.08); }
         .cell.flagged-style::before { content: 'ğŸš©'; font-size: calc(var(--cell-size) * 0.6); position: absolute; color: #f44336; text-shadow: 1px 1px 1px rgba(0,0,0,0.3); animation: flag-wobble var(--flag-wobble-duration) ease-in-out 1; transform-origin: bottom center; }
         .cell.misflagged::before { content: 'âŒ'; color: #f44336; font-size: calc(var(--cell-size) * 0.7); font-weight: bold; text-shadow: 1px 1px 1px rgba(0,0,0,0.5); position: absolute; z-index: 1; }
         .cell.misflagged { background-color: var(--cell-revealed-bg) !important; border: 1px solid var(--cell-revealed-border) !important; }
         .cell.mine.revealed-style { background-color: #795548; border-color: #5d4037; } .cell.mine.revealed-style::before { content: ''; width: 60%; height: 60%; background-color: #333; border-radius: 50%; position: absolute; box-shadow: 0 0 0 3px #555; }
         .cell.exploded-style { background-color: #f44336; animation: explode-pop 0.4s forwards; z-index: 2; } .cell.exploded-style::before{ content: 'ğŸ’¥'; font-size: calc(var(--cell-size) * 0.8); color: white; position: absolute; }
         .cell[data-adjacent-mines="1"] { color: var(--num-1); } .cell[data-adjacent-mines="2"] { color: var(--num-2); } .cell[data-adjacent-mines="3"] { color: var(--num-3); } .cell[data-adjacent-mines="4"] { color: var(--num-4); } .cell[data-adjacent-mines="5"] { color: var(--num-5); } .cell[data-adjacent-mines="6"] { color: var(--num-6); } .cell[data-adjacent-mines="7"] { color: var(--num-7); } .cell[data-adjacent-mines="8"] { color: var(--num-8); }
         /* --- Footer Controls --- */
         .footer-controls { display: flex; justify-content: space-between; align-items: center; padding: 0 5px; margin-top: auto; gap: 8px; }
         .footer-actions-left { display: flex; gap: 8px; }
         .footer-btn {
          background: transparent !important;
          border: none !important;
          outline: none !important;
          box-shadow: none !important;
          width: 64px;
          height: 64px;
          padding: 0 !important;
          margin: 0 !important;
          position: relative;
          overflow: visible !important;
        }
        .footer-btn img {
          display: block;
          width: 100%;
          height: 100%;
        }
        .footer-btn .btn-img {
          width: 100%;
          height: 100%;
          display: block;
          filter: drop-shadow(0 4px 16px #3a4edc44) drop-shadow(0 1.5px 4px #fff3);
          pointer-events: none;
          transition: filter 0.2s, transform 0.15s;
        }
        .footer-btn:hover .btn-img {
          filter: drop-shadow(0 0 16px 4px #6a7cff88) drop-shadow(0 4px 16px #3a4edc44) drop-shadow(0 1.5px 4px #fff3);
          transform: scale(1.07);
        }
        .footer-btn:active .btn-img {
          filter: drop-shadow(0 1px 2px #222);
          transform: scale(0.93);
        }
        @media (max-width: 700px) {
          .footer-btn {
            width: 48px;
            height: 48px;
          }
        }
         .mode-switch-btn[data-mode="reveal"] { background-image: url('assets/æŒ–é›·.png'); }
         .mode-switch-btn[data-mode="flag"]   { background-image: url('assets/æ’æ——.png'); }
         .hint-btn      { background-image: url('assets/æç¤º.png'); }
         .refresh-btn   { background-image: url('assets/åˆ·æ–°.png'); }
         .action-button { width: 55px; height: 55px; background-color: var(--button-primary-bg); border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 3px 6px rgba(0,0,0,0.2); position: relative; border: none; } .action-button::before, .action-button::after { content: ''; position: absolute; width: 18px; height: 5px; background-color: #333; border-radius: 3px; } .action-button::before { transform: rotate(45deg) translate(-5px, 5px); } .action-button::after { transform: rotate(-45deg) translate(5px, 5px); }
         /* --- Modals (Settings & Help) --- */
         .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--modal-overlay-bg); display: flex; justify-content: center; align-items: center; z-index: 100; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s linear 0.3s; } .modal-overlay.visible { opacity: 1; visibility: visible; transition: opacity 0.3s ease, visibility 0s linear 0s; }
         .modal-content { background-color: var(--modal-bg); border-radius: 15px; padding: 0; max-width: 90%; width: 380px; box-shadow: 0 5px 15px var(--modal-shadow); display: flex; flex-direction: column; max-height: 85vh; transform: scale(0.9); transition: transform 0.3s ease; } .modal-overlay.visible .modal-content { transform: scale(1); }
         .modal-header { background-color: var(--modal-header-bg); color: var(--modal-header-text); padding: 12px 20px; border-top-left-radius: 15px; border-top-right-radius: 15px; display: flex; justify-content: space-between; align-items: center; } .modal-header h2 { font-size: 1.4em; margin: 0; } .modal-close-btn { background: none; border: none; color: var(--modal-header-text); font-size: 24px; font-weight: bold; cursor: pointer; padding: 0 5px; line-height: 1; }
         .modal-body { padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
         .settings-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 15px; } .settings-item { display: flex; align-items: center; justify-content: space-between; } .settings-item .icon { font-size: 24px; width: 30px; text-align: center; margin-right: 10px; } .settings-item .icon.sound::before { content: 'ğŸ”Š'; } .settings-item .icon.music::before { content: 'ğŸµ'; } .settings-item .icon.vibration::before { content: 'ğŸ“³'; color: #9e9e9e; } .settings-item .label { flex-grow: 1; font-size: 1.1em; }
         .toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; cursor: pointer; } .toggle-switch input { opacity: 0; width: 0; height: 0; } .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--toggle-bg-off); transition: .4s; border-radius: 28px; } .toggle-slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 3px; bottom: 3px; background-color: var(--toggle-knob); transition: .4s; border-radius: 50%; } .toggle-switch input:checked + .toggle-slider { background-color: var(--toggle-bg-on); } .toggle-switch input:checked + .toggle-slider:before { transform: translateX(22px); } .toggle-switch.disabled { opacity: 0.6; cursor: not-allowed; } .toggle-switch.disabled .toggle-slider { background-color: var(--toggle-bg-off) !important; }
         .modal-button { background-color: var(--button-secondary-bg); color: var(--button-text); border: 2px solid var(--button-border); border-radius: 8px; padding: 10px 15px; font-size: 1.1em; font-weight: bold; cursor: pointer; text-align: center; transition: background-color 0.2s ease, transform 0.1s ease; position: relative; overflow: hidden; } .modal-button::before { content: ''; position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px; border: 2px solid var(--button-border); border-radius: 10px; transform: rotate(-1deg); opacity: 0.7; } .modal-button:active { transform: scale(0.98); }
         .modal-button.abandon { background-color: var(--button-abandon-bg); color: var(--button-abandon-text); border-color: var(--button-abandon-bg); } .modal-button.abandon::before { border-color: var(--button-abandon-bg); }
         .modal-footer-info { font-size: 0.8em; color: #666; text-align: center; margin-top: 15px; border-top: 1px solid var(--modal-border); padding-top: 15px; } .modal-footer-info p { margin-bottom: 8px; } .modal-footer-info span { background-color: #eee; padding: 2px 5px; border-radius: 4px; font-family: monospace; } .modal-footer-info button { background-color: #ddd; border: none; padding: 2px 5px; border-radius: 4px; font-size: 0.9em; cursor: pointer; margin-left: 5px; } .modal-footer-info a { color: var(--link-color); text-decoration: none; display: block; margin-top: 5px; } .modal-footer-info a:hover { text-decoration: underline; }
         #help-modal .modal-body { font-size: 1em; line-height: 1.6; }
         /* --- Play Again Button --- */
         #play-again-btn { display: none; position: absolute; bottom: 70px; left: 50%; transform: translateX(-50%); padding: 12px 25px; font-size: 1.2em; font-weight: bold; background-color: var(--button-primary-bg); color: white; border: none; border-radius: 25px; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 50; transition: transform 0.1s ease; }
         #play-again-btn:active { transform: translateX(-50%) scale(0.97); }
         #play-again-btn.visible { display: block; }
        /* --- Animations --- */
        @keyframes reveal-pop { 0%{transform:scale(.8);opacity:.6} 70%{transform:scale(1.05);opacity:1} 100%{transform:scale(1)} }
        @keyframes explode-pop { 0%{transform:scale(1)} 50%{transform:scale(1.2)} 100%{transform:scale(1);background-color:#f44336} }
        .falling-flag-element { position: absolute; width: calc(var(--cell-size) * 0.6); height: calc(var(--cell-size) * 0.6); font-size: calc(var(--cell-size) * 0.6); color: #f44336; text-shadow: 1px 1px 1px rgba(0,0,0,0.3); z-index: 6; pointer-events: none; will-change: transform, opacity; transform-origin: bottom center; animation: flag-drop var(--flag-drop-duration) cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards; }
        @keyframes flag-drop { from { transform: translateY(-150px) rotate(-30deg); opacity: 0; } to   { transform: translateY(0) rotate(0deg); opacity: 1; } }
        @keyframes flag-wobble { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(8deg); } 75% { transform: rotate(-6deg); } }
        .cell-falling-clone { position: absolute; width: var(--cell-size); height: var(--cell-size); border-radius: 6px; background-color: var(--cell-hidden-bg); box-shadow: inset 0 -2px 3px rgba(0,0,0,0.08); z-index: 5; pointer-events: none; animation: fall 0.8s cubic-bezier(0.55, 0.085, 0.68, 0.53) forwards; }
        @keyframes fall { 0%{transform:translateY(0) rotate(0deg);opacity:1} 20%{transform:translateY(calc(var(--cell-size)*.3)) rotate(5deg);opacity:1} 100%{transform:translateY(150vh) rotate(720deg);opacity:0} }
        #status { position: absolute; bottom: 130px; /* Adjusted based on Play Again button */ left: 50%; transform: translateX(-50%); background-color: rgba(0,0,0,0.7); color: white; padding: 8px 15px; border-radius: 20px; font-size: 1.1em; font-weight: bold; z-index: 10; text-align: center; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        #status.visible { opacity: 1; }
        .hint-flash { animation: hint-flash 0.7s 3; }
        @keyframes hint-flash { 0%{box-shadow:0 0 0 0 #ffd600;} 50%{box-shadow:0 0 8px 4px #ffd600;} 100%{box-shadow:0 0 0 0 #ffd600;} }
        .hint-mine { opacity:0.5; position:relative; }
        .hint-mine-icon { position:absolute; left:50%; top:50%; transform:translate(-50%,-60%); font-size:1.5em; pointer-events:none; animation: hint-mine-blink 0.7s 3; z-index:10; }
        @keyframes hint-mine-blink { 0%,100%{opacity:0;} 50%{opacity:1;} }
        .hint-count-group { display:inline-flex; gap:6px; margin-left:8px; }
        .hint-count-btn { background:#fff; border:1.5px solid #aaa; border-radius:6px; padding:2px 10px; font-size:1em; cursor:pointer; transition:background 0.2s,border 0.2s; }
        .hint-count-btn.active { background:#ffe082; border:2px solid #ffb300; color:#333; font-weight:bold; }
        .hint-count-btn:active { background:#ffe082; }
        .hint-picker-wrap { height:38px; width:60px; overflow:hidden; display:inline-block; vertical-align:middle; margin-left:10px; border-radius:8px; background:#f5f5f5; box-shadow:0 1px 4px #0001; }
        .hint-picker { display:flex; flex-direction:column; align-items:center; transition:transform 0.3s cubic-bezier(.4,1.6,.4,1); will-change:transform; }
        .hint-picker-item { height:38px; line-height:38px; font-size:1.1em; color:#888; text-align:center; width:60px; user-select:none; transition:color 0.2s, font-weight 0.2s; }
        .hint-picker-item.active { color:#ffb300; font-weight:bold; font-size:1.25em; background:#fffde7; border-radius:8px; }
        .flag-particles { position:absolute; left:50%; top:10%; pointer-events:none; z-index:20; }
        .flag-particle { position:absolute; width:7px; height:7px; border-radius:50%; opacity:0.85; }
        .cell-shake { animation: cell-shake 0.4s cubic-bezier(.36,.07,.19,.97) 1; }
        @keyframes cell-shake { 10%, 90% { transform: translate(-1px, 1px); } 20%, 80% { transform: translate(-2px, -1px); } 30%, 50%, 70% { transform: translate(2px, 2px); } 40%, 60% { transform: translate(-2px, 1px); } 100% { transform: none; } }
        .explosion-fragment { position:absolute; width:8px; height:8px; border-radius:2px; background:#ff9800; opacity:0.8; z-index:30; pointer-events:none; animation: fragment-fly 0.7s forwards; }
        @keyframes fragment-fly { 0%{transform:translate(0,0) scale(1);} 80%{opacity:1;} 100%{transform:translate(var(--tx,0),var(--ty,0)) scale(0.7); opacity:0;} }
        .victory-banner { position:fixed; top:30px; left:50%; transform:translateX(-50%); background:#ffe082; color:#ff6f00; font-size:2em; font-weight:bold; padding:12px 40px; border-radius:30px; box-shadow:0 4px 16px #0002; z-index:300; animation: banner-pop 0.7s cubic-bezier(.4,1.6,.4,1); }
        @keyframes banner-pop { 0%{transform:translateX(-50%) scale(0.7);} 60%{transform:translateX(-50%) scale(1.1);} 100%{transform:translateX(-50%) scale(1);} }
        /* å½©å¸¦åŠ¨ç”»æ ·å¼ */
        .confetti-piece {
          position: fixed;
          top: -40px;
          width: 12px;
          height: 24px;
          border-radius: 4px;
          opacity: 0.85;
          z-index: 301;
          pointer-events: none;
          animation: confetti-fall 2.2s cubic-bezier(.4,1.6,.4,1) forwards;
        }
        @keyframes confetti-fall {
          0% { transform: translateY(0) rotate(0deg); }
          80% { opacity: 1; }
          100% { transform: translateY(90vh) rotate(360deg); opacity: 0; }
        }
        /* æ——å¸œé—ªçƒåŠ¨ç”» */
        .flagged-style.flag-flash { animation: flag-flash 0.5s alternate 3; }
        @keyframes flag-flash {
          0% { filter: brightness(1.2) drop-shadow(0 0 6px #ffe082); transform: scale(1); }
          100% { filter: brightness(2) drop-shadow(0 0 16px #ffb300); transform: scale(1.18) rotate(-8deg); }
        }
        /* é…·ç‚«æ’æ——ç²’å­å’Œå…‰åœˆ */
        .flag-particle, .flag-star {
          position:absolute; opacity:0.92; pointer-events:none;
        }
        .flag-particle { width:12px; height:12px; border-radius:50%; }
        .flag-star {
          width:16px; height:16px;
          background:transparent;
          clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
        }
        .flag-flashwave {
          position:absolute; left:50%; top:50%; width:0; height:0; pointer-events:none; z-index:19;
          animation: flag-flashwave 0.6s cubic-bezier(.4,1.6,.4,1);
        }
        @keyframes flag-flashwave {
          0% { box-shadow:0 0 0 0 #ffe08288, 0 0 0 0 #fffde7; opacity:1; }
          80% { box-shadow:0 0 24px 32px #ffe08244, 0 0 0 60px #fffde733; opacity:0.7; }
          100% { box-shadow:0 0 0 80px #ffe08200, 0 0 0 120px #fffde700; opacity:0; }
        }
        /* é…·ç‚«çˆ†ç‚¸ç¢ç‰‡å’Œå†²å‡»æ³¢ */
        .explosion-fragment { position:absolute; width:12px; height:12px; border-radius:3px; opacity:0.92; z-index:30; pointer-events:none; animation: fragment-fly 0.9s forwards; }
        @keyframes fragment-fly { 0%{transform:translate(0,0) scale(1);} 80%{opacity:1;} 100%{transform:translate(var(--tx,0),var(--ty,0)) scale(0.7); opacity:0;} }
        .explosion-wave {
          position:absolute; left:50%; top:50%; width:0; height:0; pointer-events:none; z-index:29;
          animation: explosion-wave 0.7s cubic-bezier(.4,1.6,.4,1);
        }
        @keyframes explosion-wave {
          0% { box-shadow:0 0 0 0 #ff980088, 0 0 0 0 #fff176; opacity:1; }
          80% { box-shadow:0 0 32px 48px #ff980044, 0 0 0 80px #fff17633; opacity:0.7; }
          100% { box-shadow:0 0 0 120px #ff980000, 0 0 0 160px #fff17600; opacity:0; }
        }
        .cell.exploded-style { animation: explode-scale 0.5s cubic-bezier(.4,1.6,.4,1); box-shadow:0 0 24px 8px #ff9800cc; }
        @keyframes explode-scale {
          0% { transform:scale(1); }
          40% { transform:scale(1.18); }
          100% { transform:scale(1); }
        }
        .cell-shake-strong { animation: cell-shake-strong 0.5s cubic-bezier(.36,.07,.19,.97) 1; }
        @keyframes cell-shake-strong {
          10%, 90% { transform: translate(-3px, 2px); }
          20%, 80% { transform: translate(-6px, -2px); }
          30%, 50%, 70% { transform: translate(6px, 4px); }
          40%, 60% { transform: translate(-6px, 2px); }
          100% { transform: none; }
        }
        .cell-confetti-piece {
          position: absolute;
          top: -28px;
          width: 10px;
          height: 18px;
          border-radius: 3px;
          opacity: 0.9;
          z-index: 25;
          pointer-events: none;
          animation: cell-confetti-fall 0.9s cubic-bezier(.4,1.6,.4,1) forwards;
        }
        @keyframes cell-confetti-fall {
          0% { transform: translateY(0) rotate(0deg); }
          80% { opacity: 1; }
          100% { transform: translateY(38px) rotate(360deg); opacity: 0; }
        }
        .cell-firework-piece {
          position: absolute;
          left: 50%;
          top: 50%;
          width: 12px;
          height: 22px;
          border-radius: 4px;
          opacity: 0.92;
          z-index: 30;
          pointer-events: none;
          transform: translate(-50%, -50%) scale(0.7) rotate(0deg);
          animation: cell-firework-fly 0.7s cubic-bezier(.4,1.6,.4,1) forwards;
        }
        @keyframes cell-firework-fly {
          0% { opacity: 1; }
          80% { opacity: 1; }
          100% { opacity: 0; }
        }
        .cell-ribbon-piece {
          position: absolute;
          left: 50%;
          top: 50%;
          width: 10px;
          height: 36px;
          border-radius: 18px 18px 30px 30px / 18px 18px 30px 30px;
          opacity: 0.93;
          z-index: 999;
          pointer-events: none;
          transform: translate(-50%, -50%) scale(0.8) rotate(0deg);
          background: linear-gradient(120deg, #ffeb3b 0%, #ff9800 40%, #4caf50 100%);
          box-shadow: 0 0 8px 2px #fffde7aa;
          animation: ribbon-fly 1.8s cubic-bezier(.4,1.6,.4,1) forwards, ribbon-spin 1.8s linear forwards;
        }
        @keyframes ribbon-fly {
          0% { opacity: 1; }
          80% { opacity: 1; }
          100% { opacity: 0; }
        }
        @keyframes ribbon-spin {
          0% { filter: brightness(1) drop-shadow(0 0 0 #fffde7); }
          100% { filter: brightness(1.2) drop-shadow(0 0 8px #fffde7); transform: rotate(540deg) skewY(18deg) scaleX(1.1); }
        }
        .heart-lose-anim {
            animation: heart-lose 0.9s cubic-bezier(.4,1.6,.4,1);
        }
        @keyframes heart-lose {
            0% { transform: scale(1); color: #e57373; }
            30% { transform: scale(1.3) rotate(-18deg); color: #f44336; }
            60% { transform: scale(0.7) rotate(18deg); color: #bbb; }
            100% { transform: scale(1); color: #bbb; }
        }
        .status-bar .hearts-display { transition: filter 0.2s; }
        /* é¡¶éƒ¨-1â¤ï¸æç¤º */
        .lose-life-tip {
            position: fixed;
            top: 18px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,0,0,0.85);
            color: white;
            font-size: 1.3em;
            font-weight: bold;
            padding: 6px 18px;
            border-radius: 18px;
            z-index: 2000;
            box-shadow: 0 2px 8px #f4433640;
            opacity: 0.95;
            pointer-events: none;
            display: none;
        }
        @keyframes fadeOut {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }
        .level-select-group { display: flex; gap: 12px; margin-top: 4px; }
        .level-btn {
          padding: 10px 22px;
          border-radius: 22px;
          border: none;
          background: #f5f5f5;
          color: #333;
          font-size: 1.1em;
          font-weight: bold;
          box-shadow: 0 1px 4px #0001;
          transition: background 0.2s, color 0.2s;
          outline: none;
        }
        .level-btn.active, .level-btn:active {
          background: #ff9800;
          color: #fff;
        }
        .level-picker-wrap { width: 100%; display: flex; justify-content: center; align-items: center; height: 132px; overflow: hidden; margin-left: 0; }
        .level-picker { width: 120px; margin: 0 auto; height: 132px; overflow: hidden; display: flex; flex-direction: column; align-items: center; transition: transform 0.3s cubic-bezier(.4,1.6,.4,1); will-change: transform; }
        .level-picker-item { height: 44px; line-height: 44px; font-size: 1.15em; color: #888; text-align: center; width: 120px; user-select: none; transition: color 0.2s, font-weight 0.2s; }
        .level-picker-item.active { color: #ff9800; font-weight: bold; font-size: 1.25em; background: #fffde7; border-radius: 18px; }
        .settings-item-center { justify-content: center !important; text-align: center; width: 100%; display: flex; }
        .start-game-btn, .modal-button { width: 90%; max-width: 260px; margin: 0 auto 10px auto; display: block; }
        .modal-body { display: flex; flex-direction: column; align-items: stretch; }

        /* --- ä¿®å¤æç¤ºåŠ¨ç”»å’Œé«˜äº®ä¼˜å…ˆçº§ --- */
        .cell.hint-flash {
          animation: hint-flash 0.7s 3 !important;
          box-shadow: 0 0 8px 4px #ffd600 !important;
          z-index: 2;
        }
        .cell.highlighted-neighbor {
          box-shadow: 0 0 0 4px var(--highlight-outline-color) !important;
          z-index: 2;
        }
        /* çˆ†ç‚¸æ®‹ç‰‡æ ¼å­ä¸æ˜¾ç¤ºä¼ªå…ƒç´ ï¼Œé˜²æ­¢SVGè¢«é®æŒ¡ */
        .cell.mine.mine-fragment.revealed-style::before { content: none !important; }
        /* æ£‹ç›˜ç¼©æ”¾è‡ªé€‚åº”å¢å¼º */
        .board-container { overflow: auto; touch-action: pan-x pan-y; }
        .board { transition: transform 0.18s cubic-bezier(.4,1.6,.4,1); }
        @media (max-width: 700px) {
          .board-container { overflow-x: auto !important; touch-action: pan-x pan-y; }
          .board { min-width: unset !important; }
        }

        /* é¡¶éƒ¨è®¾ç½®æŒ‰é’®ç¾åŒ–ï¼ˆä»…é˜´å½±å’ŒèƒŒæ™¯å›¾ï¼Œä¸è®¾ç½®å½¢çŠ¶ï¼‰ */
        #settings-btn.icon-btn {
          background-color: transparent !important;
          border: none !important;
          outline: none !important;
          box-shadow: 0 4px 16px #3a4edc44, 0 1.5px 4px #fff3;
          background-image: url('assets/è®¾ç½®.png');
          background-size: contain;
          background-repeat: no-repeat;
          background-position: center;
          transition: box-shadow 0.2s, transform 0.15s, background 0.2s;
          width: 64px;
          height: 64px;
        }
        @media (max-width: 700px) {
          #settings-btn.icon-btn {
            width: 48px;
            height: 48px;
          }
        }
        #settings-btn.icon-btn:hover .btn-img {
          filter: drop-shadow(0 0 16px 4px #6a7cff88) drop-shadow(0 4px 16px #3a4edc44) drop-shadow(0 1.5px 4px #fff3);
          transform: scale(1.07);
        }
        #settings-btn.icon-btn:active .btn-img {
          filter: drop-shadow(0 1px 2px #222);
          transform: scale(0.93);
        }

        /* åº•éƒ¨æŒ‰é’®ç¾åŒ–ï¼ˆä»…é˜´å½±å’ŒèƒŒæ™¯å›¾ï¼Œä¸è®¾ç½®å½¢çŠ¶ï¼‰ */
        .footer-btn {
          box-shadow: 0 4px 16px #3a4edc44, 0 1.5px 4px #fff3;
          background-size: contain;
          background-repeat: no-repeat;
          background-position: center;
          transition: box-shadow 0.2s, transform 0.15s, background 0.2s;
        }
        .footer-btn:active {
          box-shadow: 0 1px 2px #222;
          transform: scale(0.93);
        }
        .footer-btn:hover {
          box-shadow: 0 0 16px 4px #6a7cff88, 0 4px 16px #3a4edc44;
        }

        /* å„æŒ‰é’®çš„å›¾ç‰‡ */
        .mode-switch-btn[data-mode="reveal"] { background-image: url('assets/æŒ–é›·.png'); }
        .mode-switch-btn[data-mode="flag"]   { background-image: url('assets/æ’æ——.png'); }
        .hint-btn      { background-image: url('assets/æç¤º.png'); }
        .refresh-btn   { background-image: url('assets/åˆ·æ–°.png'); }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 700px) {
          .footer-controls {
            justify-content: space-around;
            padding: 8px 0;
          }
          .footer-btn {
            width: 48px;
            height: 48px;
            margin: 0 4px;
          }
          #settings-btn.icon-btn {
            width: 38px;
            height: 38px;
          }
        }

        .btn-img {
          width: 100%;
          height: 100%;
          display: block;
          filter: drop-shadow(0 4px 16px #3a4edc44) drop-shadow(0 1.5px 4px #fff3);
          pointer-events: none;
        }
        .footer-btn, #settings-btn.icon-btn {
          background: transparent !important;
          border: none !important;
          outline: none !important;
          width: 64px;
          height: 64px;
          padding: 0;
          position: relative;
        }
        @media (max-width: 700px) {
          .footer-btn, #settings-btn.icon-btn {
            width: 48px;
            height: 48px;
          }
        }

        #settings-btn.icon-btn .btn-img {
          width: 100%;
          height: 100%;
          display: block;
          filter: drop-shadow(0 4px 16px #3a4edc44) drop-shadow(0 1.5px 4px #fff3);
          pointer-events: none;
        }

        .footer-controls,
        .footer-actions-left {
          background: transparent !important;
          box-shadow: none !important;
          backdrop-filter: none !important;
        }
    </style>
</head>
<body>
    <!-- Main Game Structure -->
    <div class="game-wrapper">
        <!-- Top Status Bar -->
        <div class="status-bar">
            <div class="status-left">
                <button id="settings-btn" class="icon-btn" title="è®¾ç½®" aria-label="æ‰“å¼€è®¾ç½®èœå•">
                  <img src="assets/è®¾ç½®.png" alt="è®¾ç½®" class="btn-img">
                </button>
                <button id="help-btn" class="icon-btn help-icon" title="å¸®åŠ©" aria-label="æ‰“å¼€å¸®åŠ©è¯´æ˜"></button>
                <span id="timer-display">0s</span>
            </div>
            <div class="status-center">
                 <span class="level-display">ç¬¬ä¸€å…³</span>
            </div>
            <div class="status-right">
                <div class="hearts-display" title="ç”Ÿå‘½å€¼ (æœªå®ç°)">
                    <span class="heart-icon">â¤ï¸</span><span class="heart-icon">â¤ï¸</span><span class="heart-icon">â¤ï¸</span>
                </div>
                <div class="mines-display">
                    <div class="mine-icon-display" aria-hidden="true"></div> <span id="mines-left">10</span>
                </div>
            </div>
        </div>
        <!-- Board Container -->
        <div class="board-container"> <div id="board" class="board" role="grid" aria-label="æ‰«é›·æ£‹ç›˜"></div> </div>
         <!-- Status Message -->
         <div id="status" aria-live="polite"></div>
        <!-- Footer Controls -->
        <div class="footer-controls">
             <div class="footer-actions-left">
                 <button id="mode-switch-btn" class="footer-btn mode-switch-btn" data-mode="reveal" title="åˆ‡æ¢ æŒ–å¼€/æ’æ——" aria-label="åˆ‡æ¢æ“ä½œæ¨¡å¼">
                   <img src="assets/æŒ–é›·.png" alt="æŒ–é›·" class="btn-img dig-img">
                   <img src="assets/æ’æ——.png" alt="æ’æ——" class="btn-img flag-img" style="display:none;">
                 </button>
                 <button id="hint-btn" class="footer-btn hint-btn" title="æç¤º (æœªå®ç°)" aria-label="è·å–æç¤º">
                   <img src="assets/æç¤º.png" alt="æç¤º" class="btn-img">
                 </button>
                 <button id="refresh-btn" class="footer-btn refresh-btn" title="é‡æ–°å¼€å§‹" aria-label="é‡æ–°å¼€å§‹æ¸¸æˆ">
                   <img src="assets/åˆ·æ–°.png" alt="åˆ·æ–°" class="btn-img">
                 </button>
             </div>
             <button id="zoom-btn" class="action-button" title="ç¼©æ”¾ (æœªå®ç°)" aria-label="ç¼©æ”¾è§†å›¾"></button>
             <button id="reset-btn" style="display:none;" aria-hidden="true"></button>
             <button id="safe-start-btn" style="display:none;" aria-hidden="true"></button>
        </div>
         <!-- Play Again Button -->
        <button id="play-again-btn">å†æ¥ä¸€å±€</button>
    </div>

    <!-- Modals -->
    <div id="settings-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="settings-title">
         <div class="modal-content">
             <div class="modal-header"><h2 id="settings-title">è®¾ç½®</h2><button class="modal-close-btn" data-modal-id="settings-modal" aria-label="å…³é—­è®¾ç½®">&times;</button></div>
             <div class="modal-body">
                 <ul class="settings-list">
                     <li class="settings-item"><span class="icon sound" aria-hidden="true"></span><label for="sound-toggle" class="label">éŸ³æ•ˆ</label><label class="toggle-switch"><input type="checkbox" id="sound-toggle" checked><span class="toggle-slider"></span></label></li>
                     <li class="settings-item"><span class="icon music" aria-hidden="true"></span><label for="music-toggle" class="label">éŸ³ä¹</label><label class="toggle-switch"><input type="checkbox" id="music-toggle"><span class="toggle-slider"></span></label></li>
                     <li class="settings-item"><span class="icon vibration" aria-hidden="true"></span><span class="label">éœ‡åŠ¨</span><label class="toggle-switch"><input type="checkbox" id="vibration-toggle"><span class="toggle-slider"></span></label></li>
                     <li class="settings-item"><span class="icon" aria-hidden="true">ğŸ’¡</span><span class="label">æç¤ºæ¬¡æ•°</span><div class="hint-picker-wrap"><div class="hint-picker"><div class="hint-picker-item">1</div><div class="hint-picker-item">3</div><div class="hint-picker-item">âˆ</div></div></div></li>
                     <li class="settings-item">
                       <span class="icon" aria-hidden="true">ğŸ®</span>
                       <span class="label">æ¸¸æˆç­‰çº§</span>
                       <div class="level-picker-wrap">
                         <div class="level-picker">
                           <div class="level-picker-item" data-level="easy">åˆçº§</div>
                           <div class="level-picker-item" data-level="medium">ä¸­çº§</div>
                           <div class="level-picker-item" data-level="hard">é«˜çº§</div>
                         </div>
                       </div>
                     </li>
                     <li class="settings-item settings-item-center"><button id="start-game-btn" class="modal-button start-game-btn">å¼€å§‹</button></li>
                     <li class="settings-item settings-item-center"><button class="modal-button" id="feedback-btn">é—®é¢˜åé¦ˆ</button></li>
                     <li class="settings-item settings-item-center"><button class="modal-button" id="contact-btn">è”ç³»å®¢æœ</button></li>
                     <li class="settings-item settings-item-center"><button class="modal-button abandon" id="abandon-btn">æ”¾å¼ƒæŒ‘æˆ˜</button></li>
                 </ul>
                 <button class="modal-button" id="feedback-btn">é—®é¢˜åé¦ˆ</button>
                 <button class="modal-button" id="contact-btn">è”ç³»å®¢æœ</button>
                 <button class="modal-button abandon" id="abandon-btn">æ”¾å¼ƒæŒ‘æˆ˜</button>
             </div>
             <div class="modal-footer-info">
                 <p>ç”¨æˆ·ID: <span id="user-id-display">åŠ è½½ä¸­...</span> <button id="copy-id-btn">å¤åˆ¶</button></p>
                 <a href="#" id="terms-link">ã€Šç”¨æˆ·åè®®ã€‹</a> <a href="#" id="privacy-link">ã€Šéšç§æ”¿ç­–ã€‹</a> <a href="#" id="child-privacy-link">ã€Šå„¿ç«¥éšç§ä¿æŠ¤å£°æ˜åŠç›‘æŠ¤äººé¡»çŸ¥ã€‹</a>
             </div>
         </div>
     </div>
     <div id="help-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="help-title">
         <div class="modal-content">
             <div class="modal-header"><h2 id="help-title">æ¸¸æˆå¸®åŠ©</h2><button class="modal-close-btn" data-modal-id="help-modal" aria-label="å…³é—­å¸®åŠ©">&times;</button></div>
             <div class="modal-body">
                 <p><strong>ç›®æ ‡:</strong> æ‰¾å‡ºæ‰€æœ‰å®‰å…¨æ ¼å­ï¼Œä¸è¦å¼•çˆ†ä»»ä½•åœ°é›·ï¼</p>
                 <p><strong>æ“ä½œ:</strong></p>
                 <ul>
                    <li><strong>æŒ–å¼€æ¨¡å¼ (<span aria-label="æŒ–å¼€å›¾æ ‡">â›ï¸</span>):</strong> å·¦é”®ç‚¹å‡»æ ¼å­è¿›è¡ŒæŒ–æ˜ã€‚</li>
                    <li><strong>æ’æ——æ¨¡å¼ (<span aria-label="æ——å¸œå›¾æ ‡">ğŸš©</span>):</strong> å·¦é”®ç‚¹å‡»æ ¼å­æ¥æ ‡è®°/å–æ¶ˆæ ‡è®°åœ°é›·ã€‚</li>
                    <li><strong>æ¨¡å¼åˆ‡æ¢:</strong> ç‚¹å‡»åº•éƒ¨åˆ‡æ¢æŒ‰é’® (<span aria-label="æŒ–å¼€å›¾æ ‡">â›ï¸</span>/<span aria-label="æ——å¸œå›¾æ ‡">ğŸš©</span>)ã€‚</li>
                    <li><strong>æ•°å­—å«ä¹‰:</strong> æ­å¼€çš„æ•°å­—è¡¨ç¤ºå…¶å‘¨å›´8æ ¼å†…åœ°é›·çš„æ€»æ•°ã€‚</li>
                    <li><strong>ç©ºç™½æ ¼:</strong> è‡ªåŠ¨å±•å¼€ç›¸é‚»çš„å®‰å…¨åŒºåŸŸã€‚</li>
                    <li><strong>åŒå‡»æ•°å­—:</strong> å½“å‘¨å›´æ ‡è®°çš„æ——å¸œğŸš©æ•°é‡ç­‰äºè¯¥æ•°å­—æ—¶ï¼ŒåŒå‡»å¯è‡ªåŠ¨æŒ–å¼€å‰©ä½™æœªæ ‡è®°çš„é‚»å±… (å¦‚æœæ ‡è®°é”™è¯¯ä¼šå¤±è´¥!)ã€‚</li>
                    <li><strong>å³é”®ç‚¹å‡»:</strong> å§‹ç»ˆå¯ç”¨äºæ ‡è®°/å–æ¶ˆæ ‡è®°åœ°é›·ã€‚</li>
                 </ul>
                 <p>ç¥ä½ å¥½è¿ï¼</p>
             </div>
         </div>
     </div>

    <!-- è°ƒè¯•çª—å£æŒ‰é’®å’Œçª—å£ -->
    <button id="debug-toggle-btn" style="position:fixed;bottom:10px;right:10px;z-index:200;">è°ƒè¯•çª—å£</button>
    <div id="debug-window" style="display:none;position:fixed;bottom:50px;right:10px;width:350px;height:220px;background:#222;color:#fff;font-size:13px;z-index:201;border-radius:8px;box-shadow:0 2px 8px #000a;padding:8px 8px 8px 8px;overflow-y:auto;white-space:pre-wrap;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
        <span>è°ƒè¯•æ—¥å¿—</span>
        <div style="display:flex;gap:6px;align-items:center;">
          <button id="debug-copyall-btn" style="background:#444;border:none;color:#fff;font-size:12px;cursor:pointer;padding:2px 8px;border-radius:4px;">å¤åˆ¶å…¨éƒ¨</button>
          <button id="debug-close-btn" style="background:none;border:none;color:#fff;font-size:16px;cursor:pointer;">Ã—</button>
        </div>
      </div>
      <div id="debug-log-content" style="height:170px;overflow-y:auto;user-select:text;"></div>
     </div>

    <script>
        // --- Strict Mode ---
        'use strict';

        // --- DOM Element Selection & Initial Check ---
        const boardElement = document.getElementById('board');
        const boardContainer = document.querySelector('.board-container');
        const minesLeftElement = document.getElementById('mines-left');
        const statusElement = document.getElementById('status');
        const timerDisplay = document.getElementById('timer-display');
        const settingsBtn = document.getElementById('settings-btn');
        const helpBtn = document.getElementById('help-btn');
        const settingsModal = document.getElementById('settings-modal');
        const helpModal = document.getElementById('help-modal');
        const closeModalBtns = document.querySelectorAll('.modal-close-btn');
        const abandonBtn = document.getElementById('abandon-btn');
        const soundToggle = document.getElementById('sound-toggle');
        const modeSwitchBtn = document.getElementById('mode-switch-btn');
        const hintBtn = document.getElementById('hint-btn');
        const refreshBtn = document.getElementById('refresh-btn');
        const zoomBtn = document.getElementById('zoom-btn');
        const playAgainBtn = document.getElementById('play-again-btn');
        const resetBtn = document.getElementById('reset-btn');
        const safeStartBtn = document.getElementById('safe-start-btn');

        // --- Critical Element Check ---
        if (!boardElement || !boardContainer || !minesLeftElement || !statusElement || !timerDisplay) {
            console.error("CRITICAL ERROR: Essential UI elements not found!");
            // Avoid alert in production, maybe show a static error message div
            // alert("æ¸¸æˆåŠ è½½å¤±è´¥ï¼Œå…³é”®ç•Œé¢å…ƒç´ ç¼ºå¤±ï¼");
            // For debugging, we might throw an error to see it in onerror
            throw new Error("Essential UI elements not found in DOM!");
        }

        // --- Sound Effects & State ---
        // !! IMPORTANT: Replace 'null' with actual audio file paths !!
        const sound = {
            reveal: null, // new Audio('sounds/reveal.wav'),
            explode: null, // new Audio('sounds/explosion.mp3'),
            flag: null, // new Audio('sounds/flag.ogg'),
            win: null, // new Audio('sounds/win.mp3'),
            click: null, // new Audio('sounds/click.wav')
        };
        let soundEnabled = true; // Default ON

        // --- Game Settings ---
        // åˆ é™¤ let ROWS = 10; let COLS = 10; let MINES_COUNT = 10; åªä¿ç•™å£°æ˜ï¼Œä¸èµ‹é»˜è®¤å€¼
        let ROWS, COLS, MINES_COUNT;
        const SAFE_START_EXTRA_REVEALS = 7; const ERROR_CODE_GENERAL = "GME-001";

        // --- Game State ---
        let board = []; let minesLocation = []; let minesRemaining;
        let revealedCellsCount; let gameOver; let timerInterval;
        let secondsElapsed; let firstClick; let gameInitialized = false;
        let highlightedNeighbors = []; let currentInteractionMode = 'reveal';

        // ====== æç¤ºåŠŸèƒ½ç›¸å…³ ======
        let DEFAULT_HINTS_PER_GAME = 1; // æ”¹ä¸º letï¼Œå…è®¸åŠ¨æ€èµ‹å€¼
        let hintsLeft = 1; // ä¿®å¤æœªå®šä¹‰æŠ¥é”™
        const HINT_OPTIONS = [1, 3, Infinity];
        let hintOptionIndex = 0;

        // è¾…åŠ©ï¼šé—ªçƒåŠ¨ç”»
        const HINT_FLASH_CLASS = 'hint-flash';
        const HINT_MINE_CLASS = 'hint-mine';
        const HINT_MINE_ICON_CLASS = 'hint-mine-icon';

        // ====== éœ‡åŠ¨åŠŸèƒ½ç›¸å…³ ======
        let vibrationEnabled = false;
        const vibrationToggle = document.getElementById('vibration-toggle');
        if (vibrationToggle) {
            vibrationToggle.checked = false;
            vibrationToggle.addEventListener('change', (e) => {
                vibrationEnabled = e.target.checked;
            });
        }
        function doVibrate(msOrPattern) {
            if (vibrationEnabled && navigator.vibrate) {
                navigator.vibrate(msOrPattern);
            }
        }

        // æ’å…¥ä»¿iOSæ»‘è½®é€‰æ‹©å™¨HTML
        // æ‰¾åˆ°è®¾ç½®å¼¹çª—<ul class="settings-list">ï¼Œåœ¨å…¶åæ’å…¥ï¼š
        // <li class="settings-item"><span class="icon" aria-hidden="true">ğŸ’¡</span><span class="label">æç¤ºæ¬¡æ•°</span><div class="hint-picker-wrap"><div class="hint-picker"><div class="hint-picker-item">1</div><div class="hint-picker-item">3</div><div class="hint-picker-item">âˆ</div></div></div></li>

        // æ ·å¼å¢å¼º
        (function(){
            const style = document.createElement('style');
            style.innerHTML = `
            .hint-picker-wrap { height:38px; width:60px; overflow:hidden; display:inline-block; vertical-align:middle; margin-left:10px; border-radius:8px; background:#f5f5f5; box-shadow:0 1px 4px #0001; }
            .hint-picker { display:flex; flex-direction:column; align-items:center; transition:transform 0.3s cubic-bezier(.4,1.6,.4,1); will-change:transform; }
            .hint-picker-item { height:38px; line-height:38px; font-size:1.1em; color:#888; text-align:center; width:60px; user-select:none; transition:color 0.2s, font-weight 0.2s; }
            .hint-picker-item.active { color:#ffb300; font-weight:bold; font-size:1.25em; background:#fffde7; border-radius:8px; }
            `;
            document.head.appendChild(style);
        })();

        // é€»è¾‘å®ç°
        function updateHintPickerUI() {
            const picker = document.querySelector('.hint-picker');
            const items = document.querySelectorAll('.hint-picker-item');
            items.forEach((item, idx) => {
                if (idx === hintOptionIndex) item.classList.add('active');
                else item.classList.remove('active');
            });
            // æ»šåŠ¨åˆ°é€‰ä¸­é¡¹
            if (picker) picker.style.transform = `translateY(${-38 * hintOptionIndex}px)`;
        }
        function setHintOption(idx) {
            hintOptionIndex = idx;
            DEFAULT_HINTS_PER_GAME = HINT_OPTIONS[idx];
            updateHintPickerUI();
        }
        // è§¦æ‘¸/é¼ æ ‡æ»‘åŠ¨äº‹ä»¶
        (function(){
            let startY = 0, lastY = 0, dragging = false, dragStartIdx = 0, dragDelta = 0;
            let picker = null, items = null;
            document.addEventListener('DOMContentLoaded', ()=>{
                picker = document.querySelector('.hint-picker');
                items = document.querySelectorAll('.hint-picker-item');
                if (!picker || items.length!==3) return;
                // ç‚¹å‡»é€‰é¡¹
                items.forEach((item, idx)=>{
                    item.addEventListener('click', ()=>setHintOption(idx));
                });
                // è§¦æ‘¸æ»‘åŠ¨
                picker.addEventListener('touchstart', e=>{
                    dragging = true; startY = e.touches[0].clientY; lastY = startY; dragStartIdx = hintOptionIndex; dragDelta = 0;
                });
                picker.addEventListener('touchmove', e=>{
                    if (!dragging) return;
                    let delta = e.touches[0].clientY - startY;
                    dragDelta = delta;
                    picker.style.transform = `translateY(${-38 * dragStartIdx + delta}px)`;
                });
                picker.addEventListener('touchend', ()=>{
                    if (!dragging) return;
                    let movedIdx = Math.round(dragDelta / 38);
                    let newIdx = Math.min(2, Math.max(0, dragStartIdx - movedIdx));
                    setHintOption(newIdx);
                    dragging = false; dragDelta = 0;
                });
                // é¼ æ ‡æ‹–åŠ¨
                picker.addEventListener('mousedown', e=>{ dragging=true; startY=e.clientY; dragStartIdx=hintOptionIndex; dragDelta=0; document.body.style.userSelect='none'; });
                document.addEventListener('mousemove', e=>{
                    if (!dragging) return;
                    let delta = e.clientY - startY;
                    dragDelta = delta;
                    picker.style.transform = `translateY(${-38 * dragStartIdx + delta}px)`;
                });
                document.addEventListener('mouseup', e=>{
                    if (!dragging) return;
                    let movedIdx = Math.round(dragDelta / 38);
                    let newIdx = Math.min(2, Math.max(0, dragStartIdx - movedIdx));
                    setHintOption(newIdx);
                    dragging = false; dragDelta = 0; document.body.style.userSelect='';
                });
                // é¼ æ ‡æ»šè½®
                picker.addEventListener('wheel', e=>{
                    e.preventDefault();
                    if (e.deltaY > 0 && hintOptionIndex < 2) setHintOption(hintOptionIndex+1);
                    if (e.deltaY < 0 && hintOptionIndex > 0) setHintOption(hintOptionIndex-1);
                });
                updateHintPickerUI();
            });
        })();

        // --- Global Error Handler ---
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("DEBUG: window.onerror caught an error!");
            console.error("Unhandled Error Caught:", { message, source, lineno, colno, error });
            if (statusElement) { showStatusMessage(`å‘ç”Ÿæ„å¤–é”™è¯¯ (ä»£ç : ${ERROR_CODE_GENERAL})`, true); }
            else { alert(`å‘ç”Ÿæ„å¤–é”™è¯¯ (ä»£ç : ${ERROR_CODE_GENERAL})`); }
            gameOver = true; // Prevent further interaction
            stopTimer();    // Stop timer
            return true;
        };

        // --- Utility Functions ---
        /** Plays sound if enabled. */
        function playSound(audioElement) {
            if (soundEnabled && audioElement instanceof Audio) {
                audioElement.currentTime = 0;
                audioElement.play().catch(e => console.warn("Audio play failed:", e));
            }
        }
        /** Clears neighbor highlights. */
        function clearHighlights() {
            highlightedNeighbors.forEach(element => {
                if (element) {
                    element.classList.remove('highlighted-neighbor');
                    element.classList.remove('hint-flash'); // æ–°å¢ï¼šç§»é™¤é—ªçƒ
                }
            });
            // é¢å¤–ï¼šç§»é™¤æ‰€æœ‰cellä¸Šçš„hint-flashï¼Œé˜²æ­¢ä¸­å¿ƒæ•°å­—æ®‹ç•™
            document.querySelectorAll('.cell.hint-flash').forEach(el=>el.classList.remove('hint-flash'));
            highlightedNeighbors = [];
        }
        /** Gets neighbor data objects. */
        function getNeighbors(r, c) {
            const neighbors = [];
            if (!board || !board[r]) return neighbors; // Safety check
            for (let dr = -1; dr <= 1; dr++) {
                for (let dc = -1; dc <= 1; dc++) {
                    if (dr === 0 && dc === 0) continue;
                    const nr = r + dr; const nc = c + dc;
                    if (nr >= 0 && nr < ROWS && nc >= 0 && nc < COLS && board[nr]?.[nc]) { // Check validity
                        neighbors.push(board[nr][nc]);
                    }
                }
            }
            return neighbors;
        }
        /** Shows status message. */
        function showStatusMessage(message, isError = false) {
            if (!statusElement) return;
            statusElement.textContent = message;
            statusElement.style.color = isError ? '#f44336' : 'white';
            statusElement.classList.add('visible');
        }
        /** Hides status message. */
        function hideStatusMessage() { if (statusElement) statusElement.classList.remove('visible'); }
        /** Opens a modal. */
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) { modal.classList.add('visible'); playSound(sound.click); }
        }
        /** Closes a modal. */
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) { modal.classList.remove('visible'); playSound(sound.click); }
        }

        // --- Core Game Logic ---

        /** Initializes/Resets the game. */
        function initGame() {
            if (!ROWS || !COLS || !MINES_COUNT) {
                console.error("DEBUG: Game parameters not set! ROWS/COLS/MINES_COUNT undefined or 0.");
                return;
            }
            console.log("DEBUG: Entering initGame...");
            // Critical element check at the very start
            if (!boardElement || !boardContainer || !minesLeftElement || !statusElement || !timerDisplay) {
                console.error("CRITICAL ERROR: Essential elements missing at initGame start!");
                return; // Abort if essential elements are missing
            }

            try {
                console.log('DEBUG: Initializing game state...');
                gameOver = false; firstClick = true; revealedCellsCount = 0;
                minesRemaining = MINES_COUNT; secondsElapsed = 0; gameInitialized = false;

                console.log('DEBUG: Resetting UI...');
                hideStatusMessage();
                minesLeftElement.textContent = `${minesRemaining}`;
                timerDisplay.textContent = '0s';
                stopTimer();
                clearHighlights();
                setInteractionMode('reveal'); // Default mode
                playAgainBtn.classList.remove('visible'); // Hide play again

                console.log('DEBUG: Calculating cell size...');
                // Cell Size Calculation (Robust version)
                let cellSize = 35;
                try { // Wrap calculation in try-catch as getBoundingClientRect can fail in weird states
                    const boardContainerRect = boardContainer.getBoundingClientRect();
                    if (!boardContainerRect || boardContainerRect.width <= 0 || boardContainerRect.height <= 0) {
                        console.warn("DEBUG: Board container has invalid dimensions. Using default cell size.");
                    } else {
                        const gap = 4;
                        const availableWidth = boardContainerRect.width - (COLS + 1) * gap;
                        const availableHeight = boardContainerRect.height - (ROWS + 1) * gap;
                        const sizeBasedOnWidth = Math.max(10, Math.floor(availableWidth / COLS));
                        const sizeBasedOnHeight = Math.max(10, Math.floor(availableHeight / ROWS));
                        // æ‰‹æœºç«¯æœ€å°32pxï¼ŒPCç«¯æœ€å°20px
                        let minCellSize = isMobile() ? 32 : 20;
                        cellSize = Math.max(minCellSize, Math.min(sizeBasedOnWidth, sizeBasedOnHeight, 50));
                        if (isNaN(cellSize) || cellSize <= 0) {
                            console.error("DEBUG: Calculated cell size invalid!", cellSize);
                            cellSize = 35;
                        }
                    }
                } catch (calcError) {
                     console.error("DEBUG: Error during cell size calculation:", calcError);
                     cellSize = 35; // Fallback on error
                }
                console.log("DEBUG: Final Cell Size:", cellSize);
                document.documentElement.style.setProperty('--cell-size', `${cellSize}px`);

                console.log('DEBUG: Setting board grid styles...');
                boardElement.style.setProperty('--rows', ROWS);
                boardElement.style.setProperty('--cols', COLS);
                boardElement.innerHTML = ''; // Clear board

                console.log('DEBUG: Calling createBoard()...');
                createBoard(); // Creates data and HTML

                console.log('DEBUG: Updating settings UI...');
                if (soundToggle) soundToggle.checked = soundEnabled;
                const userIdDisplay = document.getElementById('user-id-display');
                if (userIdDisplay) userIdDisplay.textContent = `dummyUser${Math.floor(Math.random()*1000)}`;

                console.log('DEBUG: initGame finished. Setting gameInitialized = true.');
                gameInitialized = true; // Game is ready

                resetHints();

            } catch (error) {
                console.error("DEBUG: Error caught within initGame try block!", error); // è¾“å‡ºè¯¦ç»†é”™è¯¯
                window.onerror("Error during game initialization", "initGame", 0, 0, error);
                gameInitialized = false; // Mark as not ready
            }
        }

        /** Creates board data array. */
        function createBoard() {
            console.log("DEBUG: Entering createBoard()...");
            board = Array.from({ length: ROWS }, () =>
                Array.from({ length: COLS }, (v, c) => ({ // More concise creation
                     isMine: false, isRevealed: false, isFlagged: false, adjacentMines: 0,
                     element: null, r: -1, c: -1 // Assign r/c later or keep index from Array.from? Let's assign later.
                }))
            );
            console.log("DEBUG: Board data created. Calling createBoardHTML()...");
            createBoardHTML();
            console.log("DEBUG: Exiting createBoard()...");
        }

        /** Creates board HTML elements. */
        function createBoardHTML() {
            console.log("DEBUG: Entering createBoardHTML()...");
            if (!boardElement) { console.error("DEBUG: Board element not found!"); return; }
            boardElement.innerHTML = ''; // Clear first

            try {
                if (!board || board.length !== ROWS) { console.error("DEBUG: Board data invalid!"); return; }
                // Use DocumentFragment for potentially better performance when adding many elements
                const fragment = document.createDocumentFragment();
                for (let r = 0; r < ROWS; r++) {
                    if (!board[r] || board[r].length !== COLS) { console.error(`DEBUG: Row ${r} data invalid!`); continue; }
                    for (let c = 0; c < COLS; c++) {
                        const cellElement = document.createElement('div');
                        cellElement.classList.add('cell', 'hidden-style');
                        cellElement.dataset.row = r; cellElement.dataset.col = c;
                        // Add ARIA roles for accessibility
                        cellElement.setAttribute('role', 'gridcell');
                        cellElement.setAttribute('aria-label', `æ ¼å­ ${r + 1} è¡Œ ${c + 1} åˆ—`); // Basic label

                        // Attach listeners
                        cellElement.addEventListener('click', handleCellClick);
                        cellElement.addEventListener('contextmenu', handleRightClick);
                        cellElement.addEventListener('dblclick', handleCellDoubleClick);

                        // Link element and update data with correct r, c
                        if (board[r][c]) {
                            board[r][c].element = cellElement;
                            board[r][c].r = r; // Assign correct row/col index
                            board[r][c].c = c;
                        } else { console.warn(`DEBUG: Missing board data for ${r},${c}`); }
                        fragment.appendChild(cellElement); // Append to fragment
                    }
                }
                boardElement.appendChild(fragment); // Append fragment to the board once
                console.log("DEBUG: Successfully created and appended all cell elements using fragment.");
            } catch (loopError) {
                 console.error("DEBUG: Error occurred inside createBoardHTML loop!", loopError);
                 window.onerror(`Error creating cell HTML`, "createBoardHTML", 0, 0, loopError);
            }
            console.log("DEBUG: Exiting createBoardHTML().");
        }


        /** Places mines randomly. */
        function placeMines(initialClickRow, initialClickCol) {
            console.log("DEBUG: Placing mines...");
            minesLocation = []; let minesPlaced = 0; let attempts = 0;
            const maxAttempts = ROWS * COLS * 10; // Prevent infinite loop in dense scenarios

            while (minesPlaced < MINES_COUNT && attempts < maxAttempts) {
                attempts++;
                const r = Math.floor(Math.random() * ROWS);
                const c = Math.floor(Math.random() * COLS);
                let isNearInitialClick = false;
                for (let dr = -1; dr <= 1; dr++) { for (let dc = -1; dc <= 1; dc++) { if (r === initialClickRow + dr && c === initialClickCol + dc) { isNearInitialClick = true; break; } } if (isNearInitialClick) break; }

                if (board[r]?.[c] && !board[r][c].isMine && !isNearInitialClick) { // Check board data exists
                   board[r][c].isMine = true;
                   minesLocation.push({ r, c });
                   minesPlaced++;
                }
            }
            if(attempts >= maxAttempts) console.warn("DEBUG: Reached max attempts placing mines.");
            console.log(`DEBUG: Placed ${minesPlaced} mines.`);
            calculateAdjacentMines();
        }

        /** Calculates adjacent mines count. */
        function calculateAdjacentMines() {
            console.log("DEBUG: Calculating adjacent mines...");
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    if (!board[r]?.[c] || board[r][c].isMine) continue; // Check data & skip mines
                    let count = 0;
                    getNeighbors(r, c).forEach(neighbor => { if (neighbor.isMine) count++; });
                    board[r][c].adjacentMines = count;
                    // Update data attribute for styling
                    if (count > 0 && board[r][c].element) { board[r][c].element.dataset.adjacentMines = count; }
                    else if (board[r][c].element) { delete board[r][c].element.dataset.adjacentMines; }
                }
            }
            console.log("DEBUG: Adjacent mines calculated.");
        }

        /** Handles the first click. */
        function handleFirstClick(r, c){
             console.log(`DEBUG: First click at ${r}, ${c}`);
             placeMines(r, c);
             startTimer();
             firstClick = false;
        }

        // --- Event Handlers ---
        /** Handles left click. */
        function handleCellClick(event) {
            autoHideStatusOnAction();
            if (gameOver || !gameInitialized) return;
            const cellElement = event.target.closest('.cell');
            if (!cellElement) return;
            const r = parseInt(cellElement.dataset.row); const c = parseInt(cellElement.dataset.col);
            if (isNaN(r) || isNaN(c) || !board[r]?.[c]) return; // Validate coords/data
            const cellData = board[r][c];
            console.log(`DEBUG: Left Click on ${r},${c}. Mode: ${currentInteractionMode}`); // Log click

            clearHighlights();

            if (currentInteractionMode === 'flag') { // Flag Mode
                if (!cellData.isRevealed) toggleFlag(r, c);
            } else { // Reveal Mode
                if (!cellData.isRevealed && !cellData.isFlagged) { // Reveal hidden
                    if (firstClick) handleFirstClick(r, c);
                    revealCell(r, c);
                } else if (cellData.isRevealed && cellData.adjacentMines > 0) { // Highlight number
                    highlightNeighbors(r, c);
                }
            }
        }

        /** Handles right click. */
        function handleRightClick(event) {
            autoHideStatusOnAction();
            event.preventDefault(); // Always prevent context menu
            if (gameOver || !gameInitialized) return;
            const cellElement = event.target.closest('.cell');
            if (!cellElement) return;
            const r = parseInt(cellElement.dataset.row); const c = parseInt(cellElement.dataset.col);
            if (isNaN(r) || isNaN(c) || !board[r]?.[c]) return;
            const cellData = board[r][c];
            console.log(`DEBUG: Right Click on ${r},${c}`);

            clearHighlights();
            if (!cellData.isRevealed) toggleFlag(r, c); // Always toggle flag on right click
        }

        /** Handles double click (Chording). */
        function handleCellDoubleClick(event) {
            autoHideStatusOnAction();
            if (gameOver || !gameInitialized) return;
            const cellElement = event.target.closest('.cell');
            if (!cellElement) return;
            const r = parseInt(cellElement.dataset.row);
            const c = parseInt(cellElement.dataset.col);
            if (isNaN(r) || isNaN(c) || !board[r]?.[c]) return;
            const cell = board[r][c];
            if (!cell.isRevealed || cell.adjacentMines <= 0) return;
            const neighbors = getNeighbors(r, c);
            // ç»Ÿè®¡å·²ç¡®å®šé›·ï¼ˆæ’æ——+çˆ†ç‚¸æ®‹ç‰‡ï¼‰
            const flagged = neighbors.filter(n => n.isFlagged).length;
            const exploded = neighbors.filter(n => n.isMine && n.element && n.element.classList.contains('mine-fragment')).length;
            const confirmedMines = flagged + exploded;
            if (confirmedMines === cell.adjacentMines) {
                neighbors.forEach(n => {
                    if (!n.isRevealed && !n.isFlagged && !(n.isMine && n.element && n.element.classList.contains('mine-fragment'))) {
                        revealCell(n.r, n.c);
                    }
                });
            }
        }


        // --- Helper Functions for Actions ---
        /** Toggles flag & animation. */
        function toggleFlag(r, c) {
             if (!board[r]?.[c]) return; // Ensure data exists
             const cellData = board[r][c];
             const cellElement = cellData.element;
             if (!cellElement || cellData.isRevealed) return;

             let playSnd = false; let isAddingFlag = false;

             if (!cellData.isFlagged && minesRemaining > 0) {
                 cellData.isFlagged = true; /* Style added AFTER animation setup */
                 minesRemaining--; playSnd = true; isAddingFlag = true;
                 // Update ARIA state
                 cellElement.setAttribute('aria-label', `æ ¼å­ ${r + 1} è¡Œ ${c + 1} åˆ— (å·²æ ‡è®°)`);
             } else if (cellData.isFlagged) {
                 cellData.isFlagged = false; cellElement.classList.remove('flagged-style');
                 minesRemaining++; playSnd = true;
                 // Update ARIA state
                  cellElement.setAttribute('aria-label', `æ ¼å­ ${r + 1} è¡Œ ${c + 1} åˆ—`);
             }
             if (playSnd) playSound(sound.flag);
             if (playSnd) doVibrate(50);
             minesLeftElement.textContent = `${minesRemaining}`;

             if (isAddingFlag) { // Trigger animation ONLY when adding
                 // Create falling flag element
                 const fallingFlag = document.createElement('div');
                 fallingFlag.textContent = 'ğŸš©'; fallingFlag.classList.add('falling-flag-element');
                 // Position calculation needs refinement if board scrolls or moves
                 fallingFlag.style.left = `${cellElement.offsetLeft + cellElement.offsetWidth / 2 - 10}px`; // Approx center
                 fallingFlag.style.top = `${cellElement.offsetTop}px`; // Start at top of cell
                 boardContainer.appendChild(fallingFlag);

                 fallingFlag.addEventListener('animationend', () => {
                     if (fallingFlag.parentNode) fallingFlag.remove();
                     // Add flagged style AFTER animation theoretically ends - might cause slight visual jump
                     // Better: Let CSS handle the wobble on the ::before element when class is added
                     if (cellData.isFlagged) { // Check state again in case quickly unflagged
                        cellElement.classList.add('flagged-style');
                        showFlagParticles(cellElement); // æ’æ——ç²’å­åŠ¨ç”»
                        showCellRibbonFirework(cellElement); // æ’æ——çƒŸèŠ±å½©å¸¦
                     }
                 });
             }
        }

        /** Highlights neighbors. */
        function highlightNeighbors(r, c) {
            clearHighlights();
            const neighbors = getNeighbors(r, c);
            neighbors.forEach(neighbor => {
                if (neighbor && neighbor.element) {
                    neighbor.element.classList.add('highlighted-neighbor');
                    highlightedNeighbors.push(neighbor.element);
                }
            });
        }

        /** Sets interaction mode. */
        function setInteractionMode(mode) {
            currentInteractionMode = mode;
            updateModeSwitchBtn(mode);
            if (modeSwitchBtn) {
                modeSwitchBtn.dataset.mode = mode;
                const nextMode = mode === 'reveal' ? 'æ’æ——' : 'æŒ–å¼€';
                modeSwitchBtn.title = `åˆ‡æ¢åˆ° ${nextMode} æ¨¡å¼`;
                 modeSwitchBtn.setAttribute('aria-label', `å½“å‰æ¨¡å¼: ${mode === 'reveal' ? 'æŒ–å¼€' : 'æ’æ——'}, ç‚¹å‡»åˆ‡æ¢åˆ° ${nextMode}`);
            }
            console.log("DEBUG: Interaction mode set to:", mode);
        }

        // --- Cell Reveal Logic ---
        /** Reveals cell. */
        function revealCell(r, c) {
            // Added detailed checks and logging within the function
            if (r < 0 || r >= ROWS || c < 0 || c >= COLS || !board[r]?.[c] || gameOver || !gameInitialized) return;
            const cellData = board[r][c];
            if (cellData.isRevealed || cellData.isFlagged) return; // å·²ç»ç¿»å¼€æˆ–æ’æ——
            const cellElement = cellData.element;
            if (!cellElement) return;

            // é˜²æ­¢å·²çˆ†ç‚¸çš„é›·å†æ¬¡çˆ†ç‚¸
            if (cellData.isMine && cellElement.classList.contains('mine')) return;

            console.log(`DEBUG: Revealing ${r},${c}`); // Log reveal start

            if (cellData.isMine) {
                if (lives > 1) {
                    lives--;
                    renderHearts();
                    showLoseHeartAnim();
                    showLoseLifeTip();
                playSound(sound.explode);
                cellElement.classList.remove('hidden-style', 'flagged-style');
                cellElement.classList.add('exploded-style');
                cellElement.setAttribute('aria-label', `æ ¼å­ ${r + 1} è¡Œ ${c + 1} åˆ— (åœ°é›·çˆ†ç‚¸)`);
                    doVibrate(400);
                    showExplosionFragments(cellElement); // çˆ†ç‚¸ç¢ç‰‡åŠ¨ç”»
                    showExplosionSmoke(cellElement);
                    setTimeout(()=>{
                        cellElement.classList.remove('exploded-style');
                        cellElement.classList.add('revealed-style', 'mine', 'mine-fragment');
                        cellElement.innerHTML = `
                        <svg width="100%" height="100%" viewBox="0 0 28 28">
                          <!-- ä¸»ä½“ -->
                          <circle cx="14" cy="15" r="8" fill="#444" stroke="#888" stroke-width="2"/>
                          <!-- å¼•ä¿¡ -->
                          <circle cx="14" cy="6" r="2.2" fill="#ffeb3b" stroke="#f44336" stroke-width="1"/>
                          <!-- é›·åˆº -->
                          <g stroke="#888" stroke-width="1.2">
                            <line x1="14" y1="23" x2="14" y2="27"/>
                            <line x1="5" y1="15" x2="1" y2="15"/>
                            <line x1="23" y1="15" x2="27" y2="15"/>
                            <line x1="7" y1="21" x2="4" y2="25"/>
                            <line x1="21" y1="21" x2="24" y2="25"/>
                            <line x1="7" y1="9" x2="4" y2="5"/>
                            <line x1="21" y1="9" x2="24" y2="5"/>
                          </g>
                          <!-- çˆ†ç‚¸æ˜Ÿæ˜Ÿ -->
                          <g>
                            <polygon points="14,2 15,4 17,4 15.5,5.5 16,7 14,6 12,7 12.5,5.5 11,4 13,4" fill="#ffd600" stroke="#f44336" stroke-width="0.5"/>
                            <polygon points="20,6 20.5,7 22,7 21,8 21.5,9 20,8.5 18.5,9 19,8 18,7 19.5,7" fill="#ffd600" stroke="#f44336" stroke-width="0.5"/>
                          </g>
                          <!-- å¤¸å¼ Xçœ¼ç› -->
                          <g stroke="#fff" stroke-width="2" stroke-linecap="round">
                            <line x1="10.5" y1="13" x2="12.5" y2="15"/>
                            <line x1="12.5" y1="13" x2="10.5" y2="15"/>
                            <line x1="15.5" y1="13" x2="17.5" y2="15"/>
                            <line x1="17.5" y1="13" x2="15.5" y2="15"/>
                          </g>
                          <!-- å¤¸å¼ æ­ªå˜´ï¼ˆæ³¢æµªçº¿ï¼‰ -->
                          <polyline points="11,18 12,19 13,18.5 14,20 15,18.5 16,19 17,18" stroke="#fff" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                          <!-- å¤§åèˆŒå¤´ -->
                          <ellipse cx="14" cy="20.2" rx="2.2" ry="1.1" fill="#e57373"/>
                          <ellipse cx="13.2" cy="20.2" rx="0.5" ry="0.3" fill="#fff"/>
                        </svg>
                        `;
                        cellElement.style.color = '';
                    }, 500);
                    getNeighbors(r, c).forEach(n=>{
                        if(n.element) {
                            n.element.classList.add('cell-shake');
                            setTimeout(()=>n.element.classList.remove('cell-shake'),400);
                        }
                    });
                    document.querySelector('.status-bar').style.filter = 'drop-shadow(0 0 8px #f44336)';
                    setTimeout(()=>{
                        document.querySelector('.status-bar').style.filter = '';
                    }, 500);
                    minesRemaining = Math.max(0, minesRemaining - 1);
                    minesLeftElement.textContent = `${minesRemaining}`;
                    return;
                }
                // æœ€åä¸€æ¬¡ç”Ÿå‘½ï¼Œæ­£å¸¸Game Over
                lives = 0;
                renderHearts();
                playSound(sound.explode);
                cellElement.classList.remove('hidden-style', 'flagged-style');
                cellElement.classList.add('exploded-style');
                cellElement.setAttribute('aria-label', `æ ¼å­ ${r + 1} è¡Œ ${c + 1} åˆ— (åœ°é›·çˆ†ç‚¸)`);
                doVibrate(400);
                showExplosionFragments(cellElement);
                showExplosionSmoke(cellElement);
                setTimeout(()=>{
                    cellElement.classList.remove('exploded-style');
                    cellElement.classList.add('revealed-style', 'mine', 'mine-fragment');
                    cellElement.innerHTML = `
                    <svg width="100%" height="100%" viewBox="0 0 28 28">
                      <!-- ä¸»ä½“ -->
                      <circle cx="14" cy="15" r="8" fill="#444" stroke="#888" stroke-width="2"/>
                      <!-- å¼•ä¿¡ -->
                      <circle cx="14" cy="6" r="2.2" fill="#ffeb3b" stroke="#f44336" stroke-width="1"/>
                      <!-- é›·åˆº -->
                      <g stroke="#888" stroke-width="1.2">
                        <line x1="14" y1="23" x2="14" y2="27"/>
                        <line x1="5" y1="15" x2="1" y2="15"/>
                        <line x1="23" y1="15" x2="27" y2="15"/>
                        <line x1="7" y1="21" x2="4" y2="25"/>
                        <line x1="21" y1="21" x2="24" y2="25"/>
                        <line x1="7" y1="9" x2="4" y2="5"/>
                        <line x1="21" y1="9" x2="24" y2="5"/>
                      </g>
                      <!-- çˆ†ç‚¸æ˜Ÿæ˜Ÿ -->
                      <g>
                        <polygon points="14,2 15,4 17,4 15.5,5.5 16,7 14,6 12,7 12.5,5.5 11,4 13,4" fill="#ffd600" stroke="#f44336" stroke-width="0.5"/>
                        <polygon points="20,6 20.5,7 22,7 21,8 21.5,9 20,8.5 18.5,9 19,8 18,7 19.5,7" fill="#ffd600" stroke="#f44336" stroke-width="0.5"/>
                      </g>
                      <!-- å¤¸å¼ Xçœ¼ç› -->
                      <g stroke="#fff" stroke-width="2" stroke-linecap="round">
                        <line x1="10.5" y1="13" x2="12.5" y2="15"/>
                        <line x1="12.5" y1="13" x2="10.5" y2="15"/>
                        <line x1="15.5" y1="13" x2="17.5" y2="15"/>
                        <line x1="17.5" y1="13" x2="15.5" y2="15"/>
                      </g>
                      <!-- å¤¸å¼ æ­ªå˜´ï¼ˆæ³¢æµªçº¿ï¼‰ -->
                      <polyline points="11,18 12,19 13,18.5 14,20 15,18.5 16,19 17,18" stroke="#fff" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                      <!-- å¤§åèˆŒå¤´ -->
                      <ellipse cx="14" cy="20.2" rx="2.2" ry="1.1" fill="#e57373"/>
                      <ellipse cx="13.2" cy="20.2" rx="0.5" ry="0.3" fill="#fff"/>
                    </svg>
                    `;
                    cellElement.style.color = '';
                }, 500);
                getNeighbors(r, c).forEach(n=>{
                    if(n.element) {
                        n.element.classList.add('cell-shake-strong');
                        n.element.style.filter = '';
                        setTimeout(()=>{
                            n.element.classList.remove('cell-shake-strong');
                            n.element.style.filter = '';
                        },500);
                    }
                });
                setTimeout(()=>{
                endGame(false);
                }, 600);
                minesRemaining = Math.max(0, minesRemaining - 1);
                minesLeftElement.textContent = `${minesRemaining}`;
                return;
            }

            // Falling Animation
            const fallingClone = cellElement.cloneNode(true);
            fallingClone.classList.add('cell-falling-clone'); fallingClone.classList.remove('hidden-style','flagged-style','highlighted-neighbor');
            fallingClone.style.left = cellElement.offsetLeft + 'px'; fallingClone.style.top = cellElement.offsetTop + 'px';
            boardContainer.appendChild(fallingClone);
            fallingClone.addEventListener('animationend', () => fallingClone.remove());

            // Reveal Safe Cell
            playSound(sound.reveal);
            cellData.isRevealed = true;
            revealedCellsCount++;
            cellElement.classList.remove('hidden-style', 'flagged-style', 'highlighted-neighbor');
            cellElement.classList.add('revealed-style');
            cellElement.textContent = ''; // Clear flag

            // Handle Number or Blank
            if (cellData.adjacentMines > 0) {
                cellElement.textContent = cellData.adjacentMines;
                 cellElement.setAttribute('aria-label', `æ ¼å­ ${r + 1} è¡Œ ${c + 1} åˆ—, ${cellData.adjacentMines} ä¸ªç›¸é‚»åœ°é›·`);
            } else { // Blank cell recursion
                 cellElement.setAttribute('aria-label', `æ ¼å­ ${r + 1} è¡Œ ${c + 1} åˆ—, å®‰å…¨åŒºåŸŸ`);
                getNeighbors(r, c).forEach(neighbor => { requestAnimationFrame(() => revealCell(neighbor.r, neighbor.c)); });
            }

            // Check win condition AFTER this cell's state is fully updated
            checkWin();
            clearHighlights(); // Clear highlights after processing
        }

        // çˆ†ç‚¸çƒŸé›¾åŠ¨ç”»
        function showExplosionSmoke(cellElement) {
            const smoke = document.createElement('div');
            smoke.style.position = 'absolute';
            smoke.style.left = '50%';
            smoke.style.top = '50%';
            smoke.style.transform = 'translate(-50%,-50%)';
            smoke.style.width = '38px';
            smoke.style.height = '38px';
            smoke.style.borderRadius = '50%';
            smoke.style.background = 'radial-gradient(circle, #fffde7cc 0%, #bbb 80%, transparent 100%)';
            smoke.style.opacity = '0.7';
            smoke.style.pointerEvents = 'none';
            smoke.style.zIndex = 30;
            smoke.style.animation = 'smoke-pop 0.7s forwards';
            cellElement.appendChild(smoke);
            setTimeout(()=>{smoke.remove();},700);
        }
        // çƒŸé›¾åŠ¨ç”»æ ·å¼
        const smokeStyle = document.createElement('style');
        smokeStyle.innerHTML = `@keyframes smoke-pop { 0%{opacity:0.7;transform:translate(-50%,-50%) scale(0.7);} 60%{opacity:0.5;transform:translate(-50%,-50%) scale(1.1);} 100%{opacity:0;transform:translate(-50%,-50%) scale(1.3);} }`;
        document.head.appendChild(smokeStyle);

        // --- Win/Loss Condition Checks ---
        /** Checks win condition. */
        function checkWin() {
            // Check only if the game is not already marked as over
            if (!gameOver) {
                 const nonMineCells = ROWS * COLS - MINES_COUNT;
                if (revealedCellsCount === nonMineCells) {
                    console.log('DEBUG: Win condition met.');
                    endGame(true);
                    return true; // Explicitly return true on win
                }
            }
             return false; // Return false if not won or already over
        }

        /** Ends game. */
        function endGame(isWin) {
             if (gameOver) return; // Prevent multiple calls
             console.log(`DEBUG: Game Over. Win: ${isWin}`);
             gameOver = true; stopTimer();

             showStatusMessage(isWin ? 'ğŸ‰ èƒœåˆ©! ğŸ‰' : 'ğŸ’¥ å¤±è´¥! ğŸ’¥', !isWin);
             if (isWin) playSound(sound.win);
             if (isWin) doVibrate(100);
             if (isWin) showVictoryBanner();
             if (isWin) flashAllFlags();

             // Reveal board
             board.forEach(row => row.forEach(cell => {
                 const cellElement = cell.element;
                 if (!cellElement) return;
                 cellElement.classList.remove('highlighted-neighbor');
                 // Reveal Mines
                 if (cell.isMine && !cellElement.classList.contains('exploded-style')) {
                     cellElement.classList.remove('hidden-style', 'flagged-style');
                     cellElement.classList.add('revealed-style', 'mine');
                      cellElement.setAttribute('aria-label', `æ ¼å­ ${cell.r + 1} è¡Œ ${cell.c + 1} åˆ— (åœ°é›·)`);
                 }
                 // Show Misflags
                 else if (!cell.isMine && cell.isFlagged) { // Check if flagged but not a mine
                      cellElement.classList.add('misflagged'); // Add cross
                      cellElement.classList.add('revealed-style'); // Ensure background is revealed
                      cellElement.setAttribute('aria-label', `æ ¼å­ ${cell.r + 1} è¡Œ ${cell.c + 1} åˆ— (é”™è¯¯æ ‡è®°)`);
                 }
             }));

             playAgainBtn.classList.add('visible'); // Show Play Again button
         }


        // --- Timer Functions ---
        /** Starts the game timer. */
        function startTimer() {
             if (timerInterval || !timerDisplay) return;
             console.log('DEBUG: Timer started.');
             timerDisplay.textContent = `${secondsElapsed}s`;
             timerInterval = setInterval(() => {
                 secondsElapsed++;
                 timerDisplay.textContent = `${secondsElapsed}s`;
             }, 1000);
         }
        /** Stops the game timer. */
        function stopTimer() {
             if (timerInterval) {
                 clearInterval(timerInterval);
                 timerInterval = null;
                 console.log('DEBUG: Timer stopped.');
             }
        }

        // --- Safe Start Function ---
        /** Logic for the safe start feature. */
        function handleSafeStartClick() { /* (Implementation from v6) */ }

        // --- Event Listener Setup ---
        /** Attaches event listeners to static elements. */
        function setupEventListeners() {
             console.log("DEBUG: Setting up event listeners...");
            try {
                 settingsBtn?.addEventListener('click', () => openModal('settings-modal'));
                 helpBtn?.addEventListener('click', () => openModal('help-modal'));
                 closeModalBtns.forEach(btn => { btn.addEventListener('click', () => closeModal(btn.dataset.modalId)); });
                 soundToggle?.addEventListener('change', (event) => { soundEnabled = event.target.checked; console.log("Sound enabled:", soundEnabled); playSound(sound.click); });
                 abandonBtn?.addEventListener('click', () => { if (!gameOver) { console.log("Challenge abandoned."); closeModal('settings-modal'); endGame(false); } });
                modeSwitchBtn?.addEventListener('click', () => { autoHideStatusOnAction(); setInteractionMode(currentInteractionMode === 'reveal' ? 'flag' : 'reveal'); playSound(sound.click); });
                refreshBtn?.addEventListener('click', () => { autoHideStatusOnAction(); playSound(sound.click); setLevel(currentLevel); });
                hintBtn?.addEventListener('click', () => { playSound(sound.click); handleHintClick(); });
                 zoomBtn?.addEventListener('click', () => { playSound(sound.click); alert("ç¼©æ”¾åŠŸèƒ½ (æœªå®ç°)"); });
                playAgainBtn?.addEventListener('click', () => { autoHideStatusOnAction(); playSound(sound.click); setLevel(currentLevel); });
                 document.getElementById('copy-id-btn')?.addEventListener('click', () => { playSound(sound.click); alert("å¤åˆ¶åŠŸèƒ½ (æœªå®ç°)"); });
                 document.getElementById('feedback-btn')?.addEventListener('click', () => { playSound(sound.click); alert("é—®é¢˜åé¦ˆ (æœªå®ç°)"); });
                 document.getElementById('contact-btn')?.addEventListener('click', () => { playSound(sound.click); alert("è”ç³»å®¢æœ (æœªå®ç°)"); });
                 document.getElementById('terms-link')?.addEventListener('click', (e) => { e.preventDefault(); playSound(sound.click); alert("ç”¨æˆ·åè®® (æœªå®ç°)"); });
                 document.getElementById('privacy-link')?.addEventListener('click', (e) => { e.preventDefault(); playSound(sound.click); alert("éšç§æ”¿ç­– (æœªå®ç°)"); });
                 document.getElementById('child-privacy-link')?.addEventListener('click', (e) => { e.preventDefault(); playSound(sound.click); alert("å„¿ç«¥éšç§ (æœªå®ç°)"); });
                 boardContainer?.addEventListener('contextmenu', e => e.preventDefault());
                 console.log("DEBUG: Event listeners setup complete.");
             } catch (listenerError) {
                  console.error("DEBUG: Error setting up event listeners!", listenerError);
                  window.onerror("Error setting up listeners", "setupEventListeners", 0, 0, listenerError);
             }
        }

        // --- Game Initialization Trigger ---
        document.addEventListener('DOMContentLoaded', () => {
            setLevel(currentLevel); // åªè°ƒç”¨setLevelï¼Œè‡ªåŠ¨åˆå§‹åŒ–å‚æ•°å’Œæ£‹ç›˜
            setupEventListeners();
            // æ’å…¥æç¤ºæ¬¡æ•°è®¾ç½®æŒ‰é’®äº‹ä»¶
            const hintBtns = document.querySelectorAll('.hint-count-btn');
            hintBtns.forEach((btn, idx) => {
                btn.addEventListener('click', () => setHintOption(idx));
            });
            updateHintPickerUI();
        });

        // --- è°ƒè¯•çª—å£å®ç° ---
        (function(){
            const debugBtn = document.getElementById('debug-toggle-btn');
            const debugWin = document.getElementById('debug-window');
            const debugClose = document.getElementById('debug-close-btn');
            const debugLog = document.getElementById('debug-log-content');
            const debugCopyAll = document.getElementById('debug-copyall-btn');
            if(debugBtn && debugWin && debugClose && debugLog){
                debugBtn.onclick = ()=>{ debugWin.style.display = debugWin.style.display==='none'?'block':'none'; };
                debugClose.onclick = ()=>{ debugWin.style.display = 'none'; };
                // æ—¥å¿—è¿½åŠ å‡½æ•°
                function appendLog(msg, type='log'){
                    const div = document.createElement('div');
                    div.textContent = `[${type}] ${msg}`;
                    div.style.color = type==='error'?'#ff8080':'#b3e5fc';
                    debugLog.appendChild(div);
                    debugLog.scrollTop = debugLog.scrollHeight;
                }
                // åŠ«æŒconsole.log/error
                const rawLog = console.log, rawErr = console.error;
                console.log = function(...args){ rawLog.apply(console, args); appendLog(args.join(' '),'log'); };
                console.error = function(...args){ rawErr.apply(console, args); appendLog(args.join(' '),'error'); };
                // æ•è·window.onerror
                window.addEventListener('error', function(e){
                    appendLog(`${e.message} @${e.filename}:${e.lineno}`,'error');
                });
                // ä¸€é”®å¤åˆ¶å…¨éƒ¨
                if(debugCopyAll){
                    debugCopyAll.onclick = function(){
                        let text = Array.from(debugLog.children).map(div=>div.textContent).join('\n');
                        if(navigator.clipboard){
                            navigator.clipboard.writeText(text).then(()=>{
                                debugCopyAll.textContent = 'å·²å¤åˆ¶!';
                                setTimeout(()=>{debugCopyAll.textContent='å¤åˆ¶å…¨éƒ¨';},1200);
                            });
                        }else{
                            // å…¼å®¹æ€§é™çº§
                            const textarea = document.createElement('textarea');
                            textarea.value = text;
                            document.body.appendChild(textarea);
                            textarea.select();
                            document.execCommand('copy');
                            document.body.removeChild(textarea);
                            debugCopyAll.textContent = 'å·²å¤åˆ¶!';
                            setTimeout(()=>{debugCopyAll.textContent='å¤åˆ¶å…¨éƒ¨';},1200);
                        }
                    };
                }
            }
        })();

        function resetHints() { hintsLeft = DEFAULT_HINTS_PER_GAME; }

        function handleHintClick() {
            if (gameOver || !gameInitialized) return;
            if (hintsLeft <= 0) { showStatusMessage('æœ¬å±€æç¤ºå·²ç”¨å®Œ', true); return; }
            // æŸ¥æ‰¾çªç ´å£
            let found = false;
            let foundType = '';
            let centerCell = null;
            let neighborCells = [];
            let mineCells = [];
            // 1. ä¼˜å…ˆæ‰¾å®‰å…¨åŒº
            outer: for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    const cell = board[r][c];
                    if (!cell.isRevealed || cell.adjacentMines <= 0) continue;
                    const allNeighbors = getNeighbors(r, c);
                    // åªç»Ÿè®¡æœªè¢«æ­å¼€çš„åœ°é›·ï¼ˆæœªçˆ†ç‚¸ã€æœªè¢«æ­å¼€ã€æœªè¢«æ’æ——ï¼‰
                    const flagged = allNeighbors.filter(n => n.isFlagged).length;
                    const hidden = allNeighbors.filter(n => !n.isRevealed && !n.isFlagged && !(n.isMine && n.element && n.element.classList.contains('mine-fragment')));
                    if (flagged === cell.adjacentMines && hidden.length > 0) {
                        found = true; foundType = 'safe'; centerCell = cell;
                        neighborCells = allNeighbors; // æ‰€æœ‰é‚»å±…éƒ½é«˜äº®
                        break outer;
                    }
                }
            }
            // 2. å†æ‰¾åœ°é›·åŒº
            if (!found) {
                outer2: for (let r = 0; r < ROWS; r++) {
                    for (let c = 0; c < COLS; c++) {
                        const cell = board[r][c];
                        if (!cell.isRevealed || cell.adjacentMines <= 0) continue;
                        const allNeighbors = getNeighbors(r, c);
                        const flagged = allNeighbors.filter(n => n.isFlagged).length;
                        // åªç»Ÿè®¡æœªè¢«æ­å¼€çš„åœ°é›·
                        const hidden = allNeighbors.filter(n => !n.isRevealed && !n.isFlagged && !(n.isMine && n.element && n.element.classList.contains('mine-fragment')));
                        if (flagged + hidden.length === cell.adjacentMines && hidden.length > 0) {
                            found = true; foundType = 'mine'; centerCell = cell;
                            neighborCells = allNeighbors; // æ‰€æœ‰é‚»å±…éƒ½é«˜äº®
                            // mineCells åªåŒ…å«æœªè¢«æ­å¼€çš„åœ°é›·
                            mineCells = hidden.filter(n => n.isMine);
                            break outer2;
                        }
                    }
                }
            }
            // 3. è§†è§‰æç¤º
            if (found && centerCell && neighborCells.length > 0) {
                hintsLeft--;
                clearHighlights();
                // --- ä¿®æ­£ï¼šä¸­å¿ƒæ•°å­—æ ¼é«˜äº® ---
                if (centerCell.element) {
                    centerCell.element.classList.remove(HINT_FLASH_CLASS); // å…ˆç§»é™¤
                    void centerCell.element.offsetWidth; // å¼ºåˆ¶é‡ç»˜
                    centerCell.element.classList.add(HINT_FLASH_CLASS);
                    setTimeout(()=>centerCell.element.classList.remove(HINT_FLASH_CLASS),2100);
                }
                // --- ä¿®æ­£ï¼šé‚»å±…æ ¼é«˜äº® ---
                neighborCells.forEach(n => {
                    if (n.element) {
                        n.element.classList.remove('highlighted-neighbor'); // å…ˆç§»é™¤
                        void n.element.offsetWidth; // å¼ºåˆ¶é‡ç»˜
                        n.element.classList.add('highlighted-neighbor');
                        highlightedNeighbors.push(n.element);
                    }
                });
                // --- åœ°é›·åŒºç‰¹æ®Šæ•ˆæœ ---
                if (foundType==='mine' && mineCells.length>0) {
                    mineCells.forEach(cell=>{
                        if(cell.element){
                            cell.element.classList.add(HINT_MINE_CLASS);
                            let icon = document.createElement('span');
                            icon.textContent = 'ğŸ’£';
                            icon.className = HINT_MINE_ICON_CLASS;
                            cell.element.appendChild(icon);
                            setTimeout(()=>{
                                cell.element.classList.remove(HINT_MINE_CLASS);
                                if(icon.parentNode) icon.parentNode.removeChild(icon);
                            },2100);
                        }
                    });
                }
                // --- åŠ¨ç”»æœŸé—´ä¸æ¸…é™¤é«˜äº®ï¼Œ2.2ç§’åç»Ÿä¸€æ¸…é™¤ ---
                setTimeout(()=>{ clearHighlights(); }, 2200);
                showStatusMessage(foundType==='safe'?'æç¤ºï¼šæ­¤åŒºåŸŸæœ‰å®‰å…¨æ ¼':'æç¤ºï¼šæ­¤åŒºåŸŸæœ‰åœ°é›·æ ¼');
            } else {
                // æ— æ˜æ˜¾çº¿ç´¢ï¼Œè‡ªåŠ¨é€‰æ‹©ä¸€ä¸ªå·²æ­ç¤ºçš„æ•°å­—æ ¼ï¼ŒæŒ‰åŸé£æ ¼é«˜äº®å…¶é‚»å±…
                let fallbackCell = null;
                let fallbackNeighbors = [];
                for (let r = 0; r < ROWS; r++) {
                    for (let c = 0; c < COLS; c++) {
                        const cell = board[r][c];
                        if (cell.isRevealed && cell.adjacentMines > 0) {
                            const allNeighbors = getNeighbors(r, c);
                            const neighbors = allNeighbors; // æ‰€æœ‰é‚»å±…éƒ½é«˜äº®
                            if (neighbors.length > 0) {
                                fallbackCell = cell;
                                fallbackNeighbors = neighbors;
                                break;
                            }
                        }
                    }
                    if (fallbackCell) break;
                }
                if (fallbackCell && fallbackNeighbors.length > 0) {
                    hintsLeft--;
                    clearHighlights();
                    if (fallbackCell.element) {
                        fallbackCell.element.classList.remove(HINT_FLASH_CLASS);
                        void fallbackCell.element.offsetWidth;
                        fallbackCell.element.classList.add(HINT_FLASH_CLASS);
                        setTimeout(()=>fallbackCell.element.classList.remove(HINT_FLASH_CLASS),2100);
                    }
                    fallbackNeighbors.forEach(n => {
                        if (n.element) {
                            n.element.classList.remove('highlighted-neighbor');
                            void n.element.offsetWidth;
                            n.element.classList.add('highlighted-neighbor');
                            highlightedNeighbors.push(n.element);
                        }
                    });
                    setTimeout(()=>{ clearHighlights(); }, 2200);
                    showStatusMessage('æš‚æ— æ˜æ˜¾çº¿ç´¢ï¼Œå·²ä¸ºä½ é«˜äº®ä¸€ä¸ªæ•°å­—æ ¼çš„é‚»å±…');
                } else {
                    showStatusMessage('æš‚æ— æ˜æ˜¾çº¿ç´¢ï¼Œè¯·å°è¯•å…¶ä»–åŒºåŸŸ', true);
                }
            }
        }

        // åœ¨ç”¨æˆ·æ“ä½œæ—¶è‡ªåŠ¨éšè—çŠ¶æ€æ æç¤º
        function autoHideStatusOnAction() { hideStatusMessage(); }

        // æ’æ——ç²’å­åŠ¨ç”»
        function showFlagParticles(cellElement) {
            const colors = ['#ffeb3b','#ff9800','#4caf50','#03a9f4','#e91e63','#fff','#f44336','#ab47bc','#00e676','#ffd600'];
            const n = 24;
            const wrap = document.createElement('div');
            wrap.className = 'flag-particles';
            wrap.style.width = '0';
            wrap.style.height = '0';
            for(let i=0;i<n;i++){
                let isStar = Math.random()<0.35;
                let p;
                if(isStar){
                    p = document.createElement('div');
                    p.className = 'flag-star';
                    p.style.background = colors[Math.floor(Math.random()*colors.length)];
                }else{
                    p = document.createElement('div');
                    p.className = 'flag-particle';
                    p.style.background = colors[Math.floor(Math.random()*colors.length)];
                }
                const angle = (2*Math.PI/n)*i + Math.random()*0.2;
                const dist = 40+Math.random()*30;
                p.style.left = Math.cos(angle)*dist+'px';
                p.style.top = Math.sin(angle)*dist+'px';
                p.style.transition = 'transform 0.7s cubic-bezier(.4,1.6,.4,1), opacity 0.7s';
                p.style.transform = 'scale(0.7) rotate('+(Math.random()*360)+'deg)';
                wrap.appendChild(p);
                setTimeout(()=>{
                    p.style.transform = `translate(${Math.cos(angle)*dist}px,${Math.sin(angle)*dist}px) scale(1.3) rotate(${Math.random()*360}deg)`;
                    p.style.opacity = '0';
                },10);
            }
            // å…‰åœˆæ‰©æ•£
            const wave = document.createElement('div');
            wave.className = 'flag-flashwave';
            wave.style.width = '0'; wave.style.height = '0';
            wrap.appendChild(wave);
            cellElement.appendChild(wrap);
            setTimeout(()=>{wrap.remove();},900);
        }

        // é…·ç‚«çˆ†ç‚¸ç¢ç‰‡å’Œå†²å‡»æ³¢åŠ¨ç”»
        function showExplosionFragments(cellElement) {
            const n = 18;
            const colors = ['#ff9800','#fff176','#fff','#f44336','#ffeb3b','#ff3d00','#ffd600'];
            for(let i=0;i<n;i++){
                const frag = document.createElement('div');
                frag.className = 'explosion-fragment';
                const angle = (2*Math.PI/n)*i+Math.random()*0.3;
                const dist = 60+Math.random()*40;
                frag.style.setProperty('--tx', Math.cos(angle)*dist+'px');
                frag.style.setProperty('--ty', Math.sin(angle)*dist+'px');
                frag.style.background = colors[Math.floor(Math.random()*colors.length)];
                frag.style.transform = 'rotate('+(Math.random()*360)+'deg)';
                cellElement.appendChild(frag);
                setTimeout(()=>{frag.remove();},900);
            }
            // å†²å‡»æ³¢
            const wave = document.createElement('div');
            wave.className = 'explosion-wave';
            wave.style.width = '0'; wave.style.height = '0';
            cellElement.appendChild(wave);
            setTimeout(()=>{wave.remove();},700);
        }

        // èƒœåˆ©æ¨ªå¹…å’Œå½©å¸¦åŠ¨ç”»å…¥å£ï¼ˆåç»­å®ç°ï¼‰
        function showVictoryBanner() {
            if(document.querySelector('.victory-banner')) return;
            const banner = document.createElement('div');
            banner.className = 'victory-banner';
            banner.textContent = 'ğŸ‰ èƒœåˆ©ï¼ğŸ‰';
            document.body.appendChild(banner);
            setTimeout(()=>{banner.remove();},2600);
        }

        // æ——å¸œä¾æ¬¡é—ªçƒ
        function flashAllFlags() {
            const flagCells = Array.from(document.querySelectorAll('.cell.flagged-style'));
            flagCells.forEach((cell, idx) => {
                setTimeout(()=>{
                    cell.classList.add('flag-flash');
                    setTimeout(()=>cell.classList.remove('flag-flash'), 1500);
                }, idx*120);
            });
        }

        // æ’æ——çƒŸèŠ±å½©å¸¦åŠ¨ç”»
        function showCellRibbonFirework(cellElement) {
            const gradients = [
                'linear-gradient(120deg, #ffeb3b 0%, #ff9800 40%, #4caf50 100%)',
                'linear-gradient(120deg, #e91e63 0%, #fff 50%, #03a9f4 100%)',
                'linear-gradient(120deg, #ab47bc 0%, #00e676 100%)',
                'linear-gradient(120deg, #ffd600 0%, #f44336 100%)',
                'linear-gradient(120deg, #fff176 0%, #ff3d00 100%)',
                'linear-gradient(120deg, #fff 0%, #ffeb3b 100%)',
                'linear-gradient(120deg, #00e676 0%, #03a9f4 100%)',
                'linear-gradient(120deg, #ff9800 0%, #e91e63 100%)'
            ];
            const n = 14;
            // è®¡ç®—æ ¼å­ä¸­å¿ƒåœ¨.board-containerå†…çš„ç»å¯¹åæ ‡
            const boardContainer = document.querySelector('.board-container');
            const cellRect = cellElement.getBoundingClientRect();
            const boardRect = boardContainer.getBoundingClientRect();
            const startX = cellRect.left + cellRect.width/2 - boardRect.left;
            const startY = cellRect.top + cellRect.height/2 - boardRect.top;
            for(let i=0;i<n;i++){
                const ribbon = document.createElement('div');
                ribbon.className = 'cell-ribbon-piece';
                ribbon.style.background = gradients[Math.floor(Math.random()*gradients.length)];
                ribbon.style.position = 'absolute';
                ribbon.style.left = startX + 'px';
                ribbon.style.top = startY + 'px';
                ribbon.style.zIndex = 999;
                // è§’åº¦åˆ†å¸ƒåœ¨360åº¦ï¼Œç•¥æœ‰éšæœº
                const angle = (2*Math.PI/n)*i + (Math.random()-0.5)*0.10;
                const dist = 160 + Math.random()*80; // 160~240px
                // æ›²çº¿å‚æ•°
                const curve = 60 + Math.random()*40; // æ›²çº¿å¼¯æ›²å¹…åº¦
                const endX = startX + Math.cos(angle)*dist;
                const endY = startY + Math.sin(angle)*dist;
                const cx = startX + Math.cos(angle+Math.PI/2)*curve;
                const cy = startY + Math.sin(angle+Math.PI/2)*curve;
                const skew = (Math.random()-0.5)*30;
                const startRotate = angle*180/Math.PI;
                // è´å¡å°”æ›²çº¿åŠ¨ç”»
                const keyframes = [
                    { offset: 0, transform: `translate(-50%, -50%) scale(0.8) rotate(${startRotate}deg) skewY(${skew}deg)`, opacity: 1 },
                    { offset: 0.7, transform: `translate(calc(-50% + ${(cx-startX)/2}px), calc(-50% + ${(cy-startY)/2}px)) scale(1) rotate(${startRotate+270}deg) skewY(${skew+9}deg)`, opacity: 1 },
                    { offset: 1, transform: `translate(calc(-50% + ${endX-startX}px), calc(-50% + ${endY-startY}px)) scale(1.1) rotate(${startRotate+540}deg) skewY(${skew+18}deg)`, opacity: 0 }
                ];
                ribbon.animate(keyframes, { duration: 1800, fill: 'forwards', easing: 'cubic-bezier(.4,1.6,.4,1)' });
                boardContainer.appendChild(ribbon);
                setTimeout(()=>{ribbon.remove();},1900);
            }
        }

        // ====== ç”Ÿå‘½å€¼ç›¸å…³ ======
        let lives = 3; // åˆå§‹ç”Ÿå‘½å€¼
        const MAX_LIVES = 3;
        const heartsDisplay = document.querySelector('.hearts-display');

        function renderHearts() {
            if (!heartsDisplay) return;
            heartsDisplay.innerHTML = '';
            for (let i = 0; i < MAX_LIVES; i++) {
                const span = document.createElement('span');
                span.className = 'heart-icon';
                if (i < lives) {
                    span.textContent = 'â¤ï¸';
                } else {
                    span.textContent = 'ğŸ’”';
                    span.style.color = '#bbb';
                }
                heartsDisplay.appendChild(span);
            }
        }

        function showLoseHeartAnim() {
            if (!heartsDisplay) return;
            const hearts = heartsDisplay.querySelectorAll('.heart-icon');
            for (let i = 0; i < hearts.length; i++) {
                if (i === lives) {
                    hearts[i].classList.add('heart-lose-anim');
                    setTimeout(()=>hearts[i].classList.remove('heart-lose-anim'), 900);
                }
            }
        }

        // é¡¶éƒ¨-1â¤ï¸æç¤º
        function showLoseLifeTip() {
            let tip = document.createElement('div');
            tip.textContent = '-1â¤ï¸';
            tip.style.position = 'fixed';
            tip.style.top = '18px';
            tip.style.left = '50%';
            tip.style.transform = 'translateX(-50%)';
            tip.style.background = 'rgba(255,0,0,0.85)';
            tip.style.color = 'white';
            tip.style.fontSize = '1.3em';
            tip.style.fontWeight = 'bold';
            tip.style.padding = '6px 18px';
            tip.style.borderRadius = '18px';
            tip.style.zIndex = 2000;
            tip.style.boxShadow = '0 2px 8px #f4433640';
            tip.style.opacity = '0.95';
            tip.style.pointerEvents = 'none';
            document.body.appendChild(tip);
            setTimeout(()=>{tip.style.opacity='0.1';}, 900);
            setTimeout(()=>{tip.remove();}, 1300);
        }

        // åœ¨initGameä¸­é‡ç½®ç”Ÿå‘½å€¼
        const oldInitGame = initGame;
        initGame = function() {
            lives = MAX_LIVES;
            renderHearts();
            oldInitGame.apply(this, arguments);
        };

        // ç­‰çº§å‚æ•°
        const LEVELS = {
          easy:   { name: 'åˆçº§', rows: 9, cols: 9, mines: 10 },
          medium: { name: 'ä¸­çº§', rows: 16, cols: 16, mines: 40 },
          hard:   { name: 'é«˜çº§', rows: 24, cols: 20, mines: 80 }
        };
        let currentLevel = 'easy';

        function setLevel(levelKey) {
            if (!LEVELS[levelKey]) return;
            currentLevel = levelKey;
            ROWS = LEVELS[levelKey].rows;
            COLS = LEVELS[levelKey].cols;
            MINES_COUNT = LEVELS[levelKey].mines;
            document.querySelector('.level-display').textContent = LEVELS[levelKey].name;
            // æ»‘è½®é«˜äº®
            document.querySelectorAll('.level-picker-item').forEach((item, idx) => {
                item.classList.toggle('active', item.dataset.level === levelKey);
            });
            // æ»‘è½®æ»šåŠ¨åˆ°å¯¹åº”ä½ç½®
            const picker = document.querySelector('.level-picker');
            const idx = ['easy','medium','hard'].indexOf(levelKey);
            picker.style.transform = `translateY(${-44*(idx)}px)`;
            initGame(); // å¿…é¡»åœ¨setLevelæœ€åè°ƒç”¨ï¼Œä¿è¯å‚æ•°æœ€æ–°
        }

        // æ»‘è½®è§¦æ‘¸/é¼ æ ‡äº‹ä»¶
        (function(){
          const picker = document.querySelector('.level-picker');
          let startY = 0, lastY = 0, dragging = false, startIdx = 0;
          picker.addEventListener('touchstart', e=>{
            dragging = true;
            startY = e.touches[0].clientY;
            lastY = picker.style.transform ? parseFloat(picker.style.transform.match(/-?\d+/)[0]) : 0;
            startIdx = ['easy','medium','hard'].indexOf(currentLevel);
          });
          picker.addEventListener('touchmove', e=>{
            if(!dragging) return;
            const dy = e.touches[0].clientY - startY;
            let newY = lastY + dy;
            // é™åˆ¶æ»‘åŠ¨èŒƒå›´
            newY = Math.max(-88, Math.min(0, newY));
            picker.style.transform = `translateY(${newY}px)`;
          });
          picker.addEventListener('touchend', e=>{
            dragging = false;
            let y = picker.style.transform ? parseFloat(picker.style.transform.match(/-?\d+/)[0]) : 0;
            let idx = Math.round(-y/44);
            idx = Math.max(0, Math.min(2, idx));
            setLevel(['easy','medium','hard'][idx]);
          });
          // é¼ æ ‡æ”¯æŒ
          picker.addEventListener('mousedown', e=>{
            dragging = true;
            startY = e.clientY;
            lastY = picker.style.transform ? parseFloat(picker.style.transform.match(/-?\d+/)[0]) : 0;
            startIdx = ['easy','medium','hard'].indexOf(currentLevel);
            e.preventDefault();
          });
          document.addEventListener('mousemove', e=>{
            if(!dragging) return;
            const dy = e.clientY - startY;
            let newY = lastY + dy;
            newY = Math.max(-88, Math.min(0, newY));
            picker.style.transform = `translateY(${newY}px)`;
          });
          document.addEventListener('mouseup', e=>{
            if(!dragging) return;
            dragging = false;
            let y = picker.style.transform ? parseFloat(picker.style.transform.match(/-?\d+/)[0]) : 0;
            let idx = Math.round(-y/44);
            idx = Math.max(0, Math.min(2, idx));
            setLevel(['easy','medium','hard'][idx]);
          });
          // æ»šè½®æ”¯æŒ
          picker.addEventListener('wheel', e => {
            e.preventDefault();
            let idx = ['easy','medium','hard'].indexOf(currentLevel);
            if (e.deltaY > 0) idx = Math.min(2, idx + 1);
            else if (e.deltaY < 0) idx = Math.max(0, idx - 1);
            setLevel(['easy','medium','hard'][idx]);
          });
        })();

        // â€œå¼€å§‹â€æŒ‰é’®é€»è¾‘
        const startGameBtn = document.getElementById('start-game-btn');
        if(startGameBtn){
          startGameBtn.addEventListener('click',()=>{
            setLevel(currentLevel); // åªéœ€setLevelï¼Œè‡ªåŠ¨åˆ·æ–°æ£‹ç›˜
            closeModal('settings-modal');
          });
        }

        // åˆ¤æ–­æ˜¯å¦ä¸ºç§»åŠ¨ç«¯
        function isMobile() {
            return /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);
        }

        // åˆ‡æ¢â€œæŒ–é›·/æ’æ——â€æŒ‰é’®å›¾ç‰‡æ˜¾ç¤º
        function updateModeSwitchBtn(mode) {
          const digImg = modeSwitchBtn.querySelector('.dig-img');
          const flagImg = modeSwitchBtn.querySelector('.flag-img');
          if (mode === 'reveal') {
            digImg.style.display = '';
            flagImg.style.display = 'none';
          } else {
            digImg.style.display = 'none';
            flagImg.style.display = '';
          }
        }
        // åˆå§‹åŒ–å’Œåˆ‡æ¢é€»è¾‘
        // updateModeSwitchBtn(currentInteractionMode);
        // modeSwitchBtn.addEventListener('click', () => {
        //   currentInteractionMode = currentInteractionMode === 'reveal' ? 'flag' : 'reveal';
        //   updateModeSwitchBtn(currentInteractionMode);
        // });
    </script>
</body>
</html>